{"version":3,"file":"AuthStateManager.js","names":["INITIAL_AUTH_STATE","DEFAULT_PENDING","updateAuthStatePromise","canceledTimes","EVENT_AUTH_STATE_CHANGE","MAX_PROMISE_CANCEL_TIMES","isSameAuthState","prevState","state","isAuthenticated","JSON","stringify","idToken","accessToken","error","AuthStateManager","constructor","sdk","emitter","AuthSdkError","_sdk","_pending","_authState","_logOptions","_prevAuthState","_transformQueue","PromiseQueue","quiet","tokenManager","on","EVENT_ADDED","key","token","_setLogOptions","event","updateAuthState","EVENT_REMOVED","options","getAuthState","getPreviousAuthState","transformAuthState","devMode","log","status","getConsole","group","groupEnd","emitAuthStateChange","authState","emit","finalPromise","origPromise","then","curPromise","cancel","cancelablePromise","PCancelable","resolve","_","onCancel","shouldReject","emitAndResolve","isCanceled","refreshToken","getTokensSync","promise","push","Promise","catch","subscribe","handler","unsubscribe","off"],"sources":["../../../lib/core/AuthStateManager.ts"],"sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\n \n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore \n// Do not use this type in code, so it won't be emitted in the declaration output\nimport PCancelable from 'p-cancelable';\nimport { AuthSdkError } from '../errors';\nimport {\n  EVENT_ADDED,\n  EVENT_REMOVED,\n  OAuthStorageManagerInterface,\n  OAuthTransactionMeta,\n  OktaAuthOAuthInterface\n} from '../oidc';\nimport {\n  AuthState,\n  AuthStateLogOptions,\n  OktaAuthCoreOptions,\n} from './types';\nimport { PromiseQueue, getConsole } from '../util';\n\nexport const INITIAL_AUTH_STATE = null;\nconst DEFAULT_PENDING = {\n  updateAuthStatePromise: null,\n  canceledTimes: 0\n};\nconst EVENT_AUTH_STATE_CHANGE = 'authStateChange';\nconst MAX_PROMISE_CANCEL_TIMES = 10;\n\n// only compare first level of authState\nconst isSameAuthState = (prevState: AuthState | null, state: AuthState) => {\n  // initial state is null\n  if (!prevState) {\n    return false;\n  }\n\n  return prevState.isAuthenticated === state.isAuthenticated \n    && JSON.stringify(prevState.idToken) === JSON.stringify(state.idToken)\n    && JSON.stringify(prevState.accessToken) === JSON.stringify(state.accessToken)\n    && prevState.error === state.error;\n};\n\n\nexport class AuthStateManager\n<\n  M extends OAuthTransactionMeta,\n  S extends OAuthStorageManagerInterface<M>,\n  O extends OktaAuthCoreOptions\n>\n{\n  _sdk: OktaAuthOAuthInterface<M, S, O>;\n  _pending: { \n    updateAuthStatePromise: any;\n    canceledTimes: number; \n  };\n  _authState: AuthState | null;\n  _prevAuthState: AuthState | null;\n  _logOptions: AuthStateLogOptions;\n  _transformQueue: PromiseQueue;\n\n  constructor(sdk: OktaAuthOAuthInterface<M, S, O>) {\n    if (!sdk.emitter) {\n      throw new AuthSdkError('Emitter should be initialized before AuthStateManager');\n    }\n\n    this._sdk = sdk;\n    this._pending = { ...DEFAULT_PENDING };\n    this._authState = INITIAL_AUTH_STATE;\n    this._logOptions = {};\n    this._prevAuthState = null;\n    this._transformQueue = new PromiseQueue({\n      quiet: true\n    });\n\n    // Listen on tokenManager events to start updateState process\n    // \"added\" event is emitted in both add and renew process\n    // Only listen on \"added\" event to update auth state\n    sdk.tokenManager.on(EVENT_ADDED, (key, token) => {\n      this._setLogOptions({ event: EVENT_ADDED, key, token });\n      this.updateAuthState();\n    });\n    sdk.tokenManager.on(EVENT_REMOVED, (key, token) => {\n      this._setLogOptions({ event: EVENT_REMOVED, key, token });\n      this.updateAuthState();\n    });\n  }\n\n  _setLogOptions(options) {\n    this._logOptions = options;\n  }\n\n  getAuthState(): AuthState | null {\n    return this._authState;\n  }\n\n  getPreviousAuthState(): AuthState | null {\n    return this._prevAuthState;\n  }\n\n  async updateAuthState(): Promise<AuthState> {\n    const { transformAuthState, devMode } = this._sdk.options;\n\n    const log = (status) => {\n      const { event, key, token } = this._logOptions;\n      getConsole().group(`OKTA-AUTH-JS:updateAuthState: Event:${event} Status:${status}`);\n      getConsole().log(key, token);\n      getConsole().log('Current authState', this._authState);\n      getConsole().groupEnd();\n      \n      // clear log options after logging\n      this._logOptions = {};\n    };\n\n    const emitAuthStateChange = (authState) => {\n      if (isSameAuthState(this._authState, authState)) {\n        devMode && log('unchanged'); \n        return;\n      }\n      this._prevAuthState = this._authState;\n      this._authState = authState;\n      // emit new authState object\n      this._sdk.emitter.emit(EVENT_AUTH_STATE_CHANGE, { ...authState });\n      devMode && log('emitted');\n    };\n\n    const finalPromise = (origPromise) => {       \n      return this._pending.updateAuthStatePromise.then(() => {\n        const curPromise = this._pending.updateAuthStatePromise;\n        if (curPromise && curPromise !== origPromise) {\n          return finalPromise(curPromise);\n        }\n        return this.getAuthState();\n      });\n    };\n\n    if (this._pending.updateAuthStatePromise) {\n      if (this._pending.canceledTimes >= MAX_PROMISE_CANCEL_TIMES) {\n        // stop canceling then starting a new promise\n        // let existing promise finish to prevent running into loops\n        devMode && log('terminated');\n        return finalPromise(this._pending.updateAuthStatePromise);\n      } else {\n        this._pending.updateAuthStatePromise.cancel();\n      }\n    }\n\n    /* eslint-disable complexity */\n    const cancelablePromise = new PCancelable((resolve, _, onCancel) => {\n      onCancel.shouldReject = false;\n      onCancel(() => {\n        this._pending.updateAuthStatePromise = null;\n        this._pending.canceledTimes = this._pending.canceledTimes + 1;\n        devMode && log('canceled');\n      });\n\n      const emitAndResolve = (authState) => {\n        if (cancelablePromise.isCanceled) {\n          resolve();\n          return;\n        }\n        // emit event and resolve promise \n        emitAuthStateChange(authState);\n        resolve();\n\n        // clear pending states after resolve\n        this._pending = { ...DEFAULT_PENDING };\n      };\n\n      this._sdk.isAuthenticated()\n        .then(() => {\n          if (cancelablePromise.isCanceled) {\n            resolve();\n            return;\n          }\n\n          const { accessToken, idToken, refreshToken } = this._sdk.tokenManager.getTokensSync();\n          const authState = {\n            accessToken,\n            idToken,\n            refreshToken,\n            isAuthenticated: !!(accessToken && idToken)\n          };\n\n          // Enqueue transformAuthState so that it does not run concurrently\n          const promise: Promise<AuthState> = transformAuthState\n            ? this._transformQueue.push(transformAuthState, null, this._sdk, authState) as Promise<AuthState>\n            : Promise.resolve(authState);\n\n          promise\n            .then(authState => emitAndResolve(authState))\n            .catch(error => emitAndResolve({\n              accessToken, \n              idToken, \n              refreshToken,\n              isAuthenticated: false, \n              error\n            }));\n        });\n    });\n    /* eslint-enable complexity */\n    this._pending.updateAuthStatePromise = cancelablePromise;\n\n    return finalPromise(cancelablePromise);\n  }\n\n  subscribe(handler): void {\n    this._sdk.emitter.on(EVENT_AUTH_STATE_CHANGE, handler);\n  }\n\n  unsubscribe(handler?): void {\n    this._sdk.emitter.off(EVENT_AUTH_STATE_CHANGE, handler);\n  }\n}\n"],"mappings":"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"}
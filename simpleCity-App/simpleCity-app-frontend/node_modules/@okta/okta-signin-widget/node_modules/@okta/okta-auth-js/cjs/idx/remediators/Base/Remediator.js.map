{"version":3,"file":"Remediator.js","names":["Remediator","constructor","remediation","values","options","formatAuthenticators","authenticators","map","authenticator","formatAuthenticator","hasAuthenticatorInList","some","existing","compareAuthenticators","push","authenticatorsData","reduce","acc","Object","keys","length","getName","name","canRemediate","required","getRequiredValues","needed","find","key","hasData","getData","allValues","getAllValues","res","data","titleCase","val","value","entry","i","getNextStep","_authClient","_context","inputs","getInputs","getAuthenticator","type","inputsFromRemediation","forEach","inputFromRemediation","input","visible","messages","alias","aliases","includes","Array","isArray","getMessages","form","field","getValuesAfterProceed","inputsFromRemediator","relatesTo","authenticatorFromRemediation","getAuthenticatorFromRemediation","id","enrollmentId"],"sources":["../../../../../lib/idx/remediators/Base/Remediator.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-non-null-assertion */\n/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n\n/* eslint-disable complexity */\nimport { OktaAuthIdxInterface, NextStep, IdxMessage, Authenticator, Input, RemediateOptions } from '../../types';\nimport { IdxAuthenticator, IdxRemediation, IdxContext } from '../../types/idx-js';\nimport { getAllValues, getRequiredValues, titleCase, getAuthenticatorFromRemediation } from '../util';\nimport { formatAuthenticator, compareAuthenticators } from '../../authenticator/util';\n\n// A map from IDX data values (server spec) to RemediationValues (client spec)\nexport type IdxToRemediationValueMap = Record<string, string[]>;\n\nexport interface RemediationValues {\n  stateHandle?: string;\n  authenticators?: (Authenticator | string)[];\n  authenticator?: string | Authenticator;\n  authenticatorsData?: Authenticator[];\n  resend?: boolean;\n}\n\nexport interface RemediatorConstructor {\n  new<T extends RemediationValues>(\n    remediation: IdxRemediation, \n    values?: T, \n    options?: RemediateOptions\n  ): any;\n}\n\n// Base class - DO NOT expose static remediationName\nexport class Remediator<T extends RemediationValues = RemediationValues> {\n  static remediationName: string;\n\n  remediation: IdxRemediation;\n  values: T;\n  options: RemediateOptions;\n  map?: IdxToRemediationValueMap;\n\n  constructor(\n    remediation: IdxRemediation, \n    values: T = {} as T, \n    options: RemediateOptions = {}\n  ) {\n    // assign fields to the instance\n    this.values = { ...values };\n    this.options = { ...options };\n    this.formatAuthenticators();\n    this.remediation = remediation;\n  }\n\n  private formatAuthenticators() {\n    this.values.authenticators = (this.values.authenticators || []) as Authenticator[];\n\n    // ensure authenticators are in the correct format\n    this.values.authenticators = this.values.authenticators.map(authenticator => {\n      return formatAuthenticator(authenticator);\n    });\n\n    // add authenticator (if any) to \"authenticators\"\n    if (this.values.authenticator) {\n      const authenticator = formatAuthenticator(this.values.authenticator);\n      const hasAuthenticatorInList = this.values.authenticators.some(existing => {\n        return compareAuthenticators(authenticator, existing);\n      });\n      if (!hasAuthenticatorInList) {\n        this.values.authenticators.push(authenticator);\n      }\n    }\n\n    // save non-key meta to \"authenticatorsData\" field\n    // authenticators will be removed after selection to avoid select-authenticator loop\n    this.values.authenticatorsData = this.values.authenticators.reduce((acc, authenticator) => {\n      if (typeof authenticator === 'object' && Object.keys(authenticator).length > 1) {\n        // save authenticator meta into authenticator data\n        acc.push(authenticator);\n      }\n      return acc;\n    }, this.values.authenticatorsData || []);\n  }\n\n  getName(): string {\n    return this.remediation.name;\n  }\n\n  // Override this method to provide custom check\n  /* eslint-disable-next-line no-unused-vars, @typescript-eslint/no-unused-vars */\n  canRemediate(): boolean {\n    const required = getRequiredValues(this.remediation);\n    const needed = required!.find((key) => !this.hasData(key));\n    if (needed) {\n      return false; // missing data for a required field\n    }\n    return true; // all required fields have available data\n  }\n\n  // returns an object for the entire remediation form, or just a part\n  getData(key?: string) {\n    if (!key) {\n      let allValues = getAllValues(this.remediation);\n      let res = allValues!.reduce((data, key) => {\n        data[key] = this.getData(key); // recursive\n        return data;\n      }, {});\n      return res;\n    }\n\n    // Map value by \"map${Property}\" function in each subClass\n    if (typeof this[`map${titleCase(key)}`] === 'function') {\n      const val = this[`map${titleCase(key)}`](\n        this.remediation.value!.find(({name}) => name === key)\n      );\n      if (val) {\n        return val;\n      }\n    }\n\n    // If a map is defined for this key, return the first aliased property that returns a truthy value\n    if (this.map && this.map[key]) {\n      const entry = this.map[key];\n      for (let i = 0; i < entry.length; i++) {\n        let val = this.values[entry[i]];\n        if (val) {\n          return val;\n        }\n      }\n    }\n\n    // fallback: return the value by key\n    return this.values[key];\n  }\n\n  hasData(\n    key: string // idx name\n  ): boolean \n  {\n    // no attempt to format, we want simple true/false\n    return !!this.getData(key);\n  }\n\n  getNextStep(_authClient: OktaAuthIdxInterface, _context?: IdxContext): NextStep {\n    const name = this.getName();\n    const inputs = this.getInputs();\n    const authenticator = this.getAuthenticator();\n    // TODO: remove type field in the next major version change\n    // https://oktainc.atlassian.net/browse/OKTA-431749\n    const type = authenticator?.type;\n    return { \n      name, \n      inputs, \n      ...(type && { type }),\n      ...(authenticator && { authenticator }),\n    };\n  }\n\n  // Get inputs for the next step\n  getInputs(): Input[] {\n    const inputs: Input[] = [];\n    const inputsFromRemediation = this.remediation.value || [];\n    inputsFromRemediation.forEach(inputFromRemediation => {\n      let input;\n      let { name, type, visible, messages } = inputFromRemediation;\n      if (visible === false) {\n        return; // Filter out invisible inputs, like stateHandle\n      }\n      if (typeof this[`getInput${titleCase(name)}`] === 'function') {\n        input = this[`getInput${titleCase(name)}`](inputFromRemediation);\n      } else if (type !== 'object') {\n        // handle general primitive types\n        let alias;\n        const aliases = (this.map ? this.map[name] : null) || [];\n        if (aliases.length === 1) {\n          alias = aliases[0];\n        } else {\n          // try find key from values\n          alias = aliases.find(name => Object.keys(this.values).includes(name));\n        }\n        if (alias) {\n          input = { ...inputFromRemediation, name: alias };\n        }\n      }\n      if (!input) {\n        input = inputFromRemediation;\n      }\n      if (Array.isArray(input)) {\n        input.forEach(i => inputs.push(i));\n      } else {\n        // guarantees field-level messages are passed back\n        if (messages) {\n          input.messages = messages;\n        }\n        inputs.push(input);\n      }\n    });\n    return inputs;\n  }\n\n  static getMessages(remediation: IdxRemediation): IdxMessage[] | undefined {\n    if (!remediation.value) {\n      return;\n    }\n    return remediation.value[0]?.form?.value.reduce((messages: IdxMessage[], field) => {\n      if (field.messages) {\n        messages = [...messages, ...field.messages.value];\n      }\n      return messages;\n    }, []);\n  }\n\n  // Prepare values for the next remediation\n  // In general, remove used values from inputs for the current remediation\n  // Override this method if special cases need be handled\n  getValuesAfterProceed(): T {\n    const inputsFromRemediation = this.remediation.value || []; // \"raw\" inputs from server response\n    const inputsFromRemediator = this.getInputs(); // \"aliased\" inputs from SDK remediator\n    const inputs = [\n      ...inputsFromRemediation,\n      ...inputsFromRemediator\n    ];\n    // scrub all values related to this remediation\n    for (const input of inputs) {\n      delete this.values[input.name];\n    }\n    return this.values;\n  }\n\n  protected getAuthenticator(): IdxAuthenticator | undefined {\n    // relatesTo value may be an authenticator or an authenticatorEnrollment\n    const relatesTo = this.remediation.relatesTo?.value;\n    if (!relatesTo) {\n      return;\n    }\n\n    const authenticatorFromRemediation = getAuthenticatorFromRemediation(this.remediation);\n    if (!authenticatorFromRemediation) {\n      // Hopefully value is an authenticator\n      return relatesTo;\n    }\n\n    // If relatesTo is an authenticatorEnrollment, the id is actually the enrollmentId\n    // Let's get the correct authenticator id from the form value\n    const id = authenticatorFromRemediation.form!.value\n      .find(({ name }) => name === 'id')!.value as string;\n    const enrollmentId = authenticatorFromRemediation.form!.value\n      .find(({ name }) => name === 'enrollmentId')?.value as string;\n\n    return {\n      ...relatesTo,\n      id,\n      enrollmentId\n    };\n  }\n}\n"],"mappings":"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"}
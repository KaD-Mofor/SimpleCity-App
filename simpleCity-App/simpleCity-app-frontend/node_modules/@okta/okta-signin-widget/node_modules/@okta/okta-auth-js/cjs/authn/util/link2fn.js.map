{"version":3,"file":"link2fn.js","names":["link2fn","sdk","tx","res","obj","link","ref","Array","isArray","name","opts","AuthSdkError","lk","find","hints","allow","length","method","get","href","withCredentials","isPolling","data","addStateToken","status","Object","assign","factorType","provider","params","autoPush","undefined","e","Promise","reject","omit","rememberDevice","profile","updatePhone","toQueryString","postToTransaction"],"sources":["../../../../lib/authn/util/link2fn.ts"],"sourcesContent":["import { OktaAuthHttpInterface } from '../../http/types';\nimport { find, omit, toQueryString } from '../../util';\nimport AuthSdkError from '../../errors/AuthSdkError';\nimport { get } from '../../http';\nimport { AuthnTransactionAPI, AuthnTransactionState } from '../types';\nimport { postToTransaction } from '../api';\nimport { addStateToken } from './stateToken';\n\n\n// query parameters to post url\ninterface PostToTransactionParams {\n  autoPush?: boolean;\n  rememberDevice?: boolean;\n  updatePhone?: boolean;\n}\n\n// eslint-disable-next-line max-params\nexport function link2fn(sdk: OktaAuthHttpInterface, tx: AuthnTransactionAPI, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function(name, opts?) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = find(link, {name: name});\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, tx, res, obj, lk, ref)(opts);\n    };\n\n  } else if (link.hints &&\n      link.hints.allow &&\n      link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n    switch (method) {\n\n      case 'GET':\n        return function() {\n          return get(sdk, link.href, { withCredentials: true });\n        };\n\n      case 'POST':\n        // eslint-disable-next-line max-statements,complexity\n        return function(opts: AuthnTransactionState) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL' || res.status === 'FACTOR_ENROLL') {\n            // Add factorType and provider\n            Object.assign(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var params = {} as PostToTransactionParams;\n          var autoPush = data.autoPush;\n          if (autoPush !== undefined) {\n            if (typeof autoPush === 'function') {\n              try {\n                params.autoPush = !!autoPush();\n              }\n              catch (e) {\n                return Promise.reject(new AuthSdkError('AutoPush resulted in an error.'));\n              }\n            }\n            else if (autoPush !== null) {\n              params.autoPush = !!autoPush;\n            }\n            data = omit(data, 'autoPush');\n          }\n\n          var rememberDevice = data.rememberDevice;\n          if (rememberDevice !== undefined) {\n            if (typeof rememberDevice === 'function') {\n              try {\n                params.rememberDevice = !!rememberDevice();\n              }\n              catch (e) {\n                return Promise.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n              }\n            }\n            else if (rememberDevice !== null) {\n              params.rememberDevice = !!rememberDevice;\n            }\n            data = omit(data, 'rememberDevice');\n\n          } else if (data.profile &&\n                    data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              params.updatePhone = true;\n            }\n            data.profile = omit(data.profile, 'updatePhone');\n          }\n          var href = link.href + toQueryString(params);\n          return postToTransaction(sdk, tx, href, data);\n        };\n    }\n  }\n}\n\n\n"],"mappings":"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"}
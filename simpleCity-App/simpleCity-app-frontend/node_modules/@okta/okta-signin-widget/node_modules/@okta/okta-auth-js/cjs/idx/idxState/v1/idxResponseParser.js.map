{"version":3,"file":"idxResponseParser.js","names":["SKIP_FIELDS","Object","fromEntries","map","field","parseNonRemediations","authClient","idxResponse","toPersist","actions","context","keys","filter","forEach","fieldIsObject","rel","name","generateIdxAction","value","fieldValue","type","info","entries","subField","expandRelatesTo","k","query","Array","isArray","result","JSONPath","path","json","innerValue","convertRemediationAction","remediation","remediationActions","generateRemediationFunctions","actionFn","action","parseIdxResponse","remediationData","remediations"],"sources":["../../../../../lib/idx/idxState/v1/idxResponseParser.ts"],"sourcesContent":["/*!\n * Copyright (c) 2021-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint-disable max-len */\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-nocheck\nimport { OktaAuthIdxInterface } from '../../types';    // auth-js/types\nimport { generateRemediationFunctions } from './remediationParser';\nimport generateIdxAction from './generateIdxAction';\nimport { JSONPath } from 'jsonpath-plus';\n\nconst SKIP_FIELDS = Object.fromEntries([\n  'remediation', // remediations are put into proceed/neededToProceed\n  'context', // the API response of 'context' isn't externally useful.  We ignore it and put all non-action (contextual) info into idxState.context\n].map( (field) => [ field, !!'skip this field' ] ));\n\nexport const parseNonRemediations = function parseNonRemediations( authClient: OktaAuthIdxInterface, idxResponse, toPersist = {} ) {\n  const actions = {};\n  const context = {};\n\n  Object.keys(idxResponse)\n    .filter( field => !SKIP_FIELDS[field])\n    .forEach( field => {\n      const fieldIsObject = typeof idxResponse[field] === 'object' && !!idxResponse[field];\n\n      if ( !fieldIsObject ) {\n        // simple fields are contextual info\n        context[field] = idxResponse[field];\n        return;\n      }\n\n      if ( idxResponse[field].rel ) {\n        // top level actions\n        actions[idxResponse[field].name] = generateIdxAction(authClient, idxResponse[field], toPersist);\n        return;\n      }\n\n      const { value: fieldValue, type, ...info} = idxResponse[field];\n      context[field] = { type, ...info}; // add the non-action parts as context\n\n      if ( type !== 'object' ) {\n        // only object values hold actions\n        context[field].value = fieldValue;\n        return;\n      }\n\n      // We are an object field containing an object value\n      context[field].value = {};\n      Object.entries(fieldValue)\n        .forEach( ([subField, value]) => {\n          if (value.rel) { // is [field].value[subField] an action?\n            // add any \"action\" value subfields to actions\n            actions[`${field}-${subField.name || subField}`] = generateIdxAction(authClient, value, toPersist);\n          } else {\n            // add non-action value subfields to context\n            context[field].value[subField] = value;\n          }\n        });\n    });\n\n  return { context, actions };\n};\n\nconst expandRelatesTo = (idxResponse, value) => {\n  Object.keys(value).forEach(k => {\n    if (k === 'relatesTo') {\n      const query = Array.isArray(value[k]) ? value[k][0] : value[k];\n      if (typeof query === 'string') {\n        // eslint-disable-next-line new-cap\n        const result = JSONPath({ path: query, json: idxResponse })[0];\n        if (result) {\n          value[k] = result;\n          return;\n        }\n      }\n    }\n    if (Array.isArray(value[k])) {\n      value[k].forEach(innerValue => expandRelatesTo(idxResponse, innerValue));\n    }\n  });\n};\n\nconst convertRemediationAction = (authClient: OktaAuthIdxInterface, remediation, toPersist) => {\n  // Only remediation that has `rel` field (indicator for form submission) can have http action\n  if (remediation.rel) {\n    const remediationActions = generateRemediationFunctions( authClient, [remediation], toPersist );\n    const actionFn = remediationActions[remediation.name];\n    return {\n      ...remediation,\n      action: actionFn,\n    };\n  }\n  \n  return remediation;\n};\n\nexport const parseIdxResponse = function parseIdxResponse( authClient: OktaAuthIdxInterface, idxResponse, toPersist = {} ): {\n  remediations: IdxRemediation[];\n  context: IdxContext;\n  actions: IdxActions;\n} {\n  const remediationData = idxResponse.remediation?.value || [];\n\n  remediationData.forEach(\n    remediation => expandRelatesTo(idxResponse, remediation)\n  );\n\n  const remediations = remediationData.map(remediation => convertRemediationAction( authClient, remediation, toPersist ));\n\n  const { context, actions } = parseNonRemediations( authClient, idxResponse, toPersist );\n\n  return {\n    remediations,\n    context,\n    actions,\n  };\n};\n"],"mappings":"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"}
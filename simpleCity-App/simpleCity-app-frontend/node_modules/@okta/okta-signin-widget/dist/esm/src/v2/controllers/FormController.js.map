{"version":3,"file":"FormController.js","sources":["../../../../../src/v2/controllers/FormController.ts"],"sourcesContent":["/*!\n * Copyright (c) 2020, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\nimport { _, Controller, loc } from '@okta/courage';\nimport ViewFactory from '../view-builder/ViewFactory';\nimport IonResponseHelper from '../ion/IonResponseHelper';\nimport { getV1ClassName } from '../ion/ViewClassNamesFactory';\nimport { FORMS, TERMINAL_FORMS, FORM_NAME_TO_OPERATION_MAP } from '../ion/RemediationConstants';\nimport transformPayload from '../ion/payloadTransformer';\nimport Util from 'util/Util';\nimport sessionStorageHelper from '../client/sessionStorageHelper';\nimport { HttpResponse, IdxStatus, ProceedOptions } from '@okta/okta-auth-js';\nimport { EventErrorContext } from 'types/events';\nimport { CONFIGURED_FLOW } from '../client/constants';\nimport { ConfigError } from 'util/Errors';\nimport { updateAppState } from 'v2/client';\nimport CookieUtil from '../../util/CookieUtil';\nimport BrowserFeatures from \"util/BrowserFeatures\";\n\nexport interface ContextData {\n  controller: string;\n  formName: string;\n  authenticatorKey?: string;\n  methodType?: string;\n}\n\nexport default Controller.extend({\n  className: 'form-controller',\n\n  appStateEvents: {\n    'change:currentFormName': 'handleFormNameChange',\n    'afterError': 'handleAfterError',\n    'invokeAction': 'handleInvokeAction',\n    'saveForm': 'handleSaveForm',\n    'switchForm': 'handleSwitchForm',\n  },\n\n  preRender() {\n    this.removeChildren();\n  },\n\n  postRender() {\n    const currentViewState = this.options.appState.getCurrentViewState();\n    // TODO: add comments regarding when `currentViewState` would be null?\n    if (!currentViewState) {\n      return;\n    }\n\n    this.clearMetadata();\n\n    let formName = currentViewState.name;\n    if (formName === 'identify' && this.options.settings.get('flow') === CONFIGURED_FLOW.RESET_PASSWORD) {\n      formName = 'identify-recovery';\n    }\n    const TheView = ViewFactory.create(\n      formName,\n      this.options.appState.get('authenticatorKey'),\n    );\n    try {\n      this.formView = this.add(TheView, {\n        options: {\n          currentViewState,\n        }\n      }).last();\n    } catch (error) {\n      // This is the place where runtime error (NPE) happens at most of time.\n      // It has been swallowed by Q.js hence add try/catch to surface up errors.\n      this.options.settings.callGlobalError(error);\n      return;\n    }\n\n    this.triggerAfterRenderEvent();\n  },\n\n  clearMetadata() {\n    const formName = this.options.appState.get('currentFormName');\n    // TODO: OKTA-392835 shall not clear state handle at terminal page\n    if (TERMINAL_FORMS.includes(formName)) {\n      sessionStorageHelper.removeStateHandle();\n    }\n  },\n\n  triggerAfterRenderEvent() {\n    const contextData = this.createAfterEventContext();\n    this.trigger('afterRender', contextData);\n  },\n\n  handleFormNameChange() {\n    this.render();\n  },\n\n  handleAfterError(error: HttpResponse) {\n    const contextData = this.createAfterEventContext();\n    const errorContextData: EventErrorContext = {\n      xhr: error,\n      errorSummary: error.responseJSON && error.responseJSON.errorSummary,\n    };\n    // TODO: need some enhancement after https://github.com/okta/okta-idx-js/pull/27\n    // OKTA-318062\n    this.trigger('afterError', contextData, errorContextData);\n  },\n\n  createAfterEventContext(): ContextData {\n    const formName = this.options.appState.get('currentFormName');\n    const authenticatorKey = this.options.appState.get('authenticatorKey');\n    const methodType = this.options.appState.get('authenticatorMethodType');\n    const isPasswordRecoveryFlow = this.options.appState.get('isPasswordRecoveryFlow');\n\n    const v1ControllerClassName = getV1ClassName(\n      formName,\n      authenticatorKey,\n      methodType,\n      isPasswordRecoveryFlow,\n    );\n\n    const eventData: ContextData = {\n      controller: v1ControllerClassName,\n      formName,\n    };\n\n    if (authenticatorKey) {\n      eventData.authenticatorKey = authenticatorKey;\n    }\n    if (methodType) {\n      eventData.methodType = methodType;\n    }\n\n    return eventData;\n  },\n\n  handleSwitchForm(formName) {\n    // trigger formName change to change view\n    if (this.options.appState.get('messages')) {\n      // Clear messages before calling switch form.\n      // If a form has errors sent form API inside messages\n      // and user hits back to factors list which triggers switchForm,\n      // those error will show up on another screen that gets rendered after switchForm\n      this.options.appState.unset('messages');\n    }\n    this.options.appState.set('currentFormName', formName);\n  },\n\n  // eslint-disable-next-line max-statements\n  async handleInvokeAction(actionPath = '', actionParams = {}) {\n    const { appState, settings } = this.options;\n    const idx = appState.get('idx');\n    const { stateHandle } = idx.context;\n    let invokeOptions: ProceedOptions = {\n      exchangeCodeForTokens: false, // we handle this in interactionCodeFlow.js\n      stateHandle\n    };\n    let error;\n\n    // Cancel action is executes synchronously\n    if (actionPath === 'cancel') {\n      // TODO: resolve race conditions caused by event pattern: OKTA-490220\n      settings.getAuthClient().transactionManager.clear({ clearIdxResponse: false });\n      sessionStorageHelper.removeStateHandle();\n      appState.clearAppStateCache();\n\n      if (settings.get('oauth2Enabled')) {\n        // In this case we need to restart login flow and recreate transaction meta\n        // that will be used in interactionCodeFlow function\n        appState.trigger('restartLoginFlow');\n        return;\n      }\n    }\n\n    // Build options to invoke or throw error for invalid action\n    if (FORMS.LAUNCH_AUTHENTICATOR === actionPath && actionParams) {\n      //https://oktainc.atlassian.net/browse/OKTA-562885  a temp solution to send rememberMe when click the launch OV buttion.\n      //will redesign to handle FastPass silent probing case where no username and rememberMe opiton at all.\n      invokeOptions = {\n        ...invokeOptions,\n        actions: [{\n          name: actionPath,\n          params: actionParams\n        }]\n      };\n    } else if (idx['neededToProceed'].find(item => item.name === actionPath)) {\n      invokeOptions = { ...invokeOptions, step: actionPath };\n    } else if (_.isFunction(idx['actions'][actionPath])) {\n      invokeOptions = {\n        ...invokeOptions,\n        actions: [{\n          name: actionPath,\n          params: actionParams\n        }]\n      };\n    } else {\n      error = new ConfigError(`Invalid action selected: ${actionPath}`);\n      this.options.settings.callGlobalError(error);\n      await this.showFormErrors(this.formView.model, error, this.formView.form);\n      return;\n    }\n\n    // action will be executed asynchronously\n    await this.invokeAction(invokeOptions);\n  },\n\n  async invokeAction(invokeOptions) {\n    const authClient = this.options.settings.getAuthClient();\n    let resp;\n    let error;\n    try {\n      resp = await authClient.idx.proceed(invokeOptions);\n      if (resp.requestDidSucceed === false) {\n        error = resp;\n      }\n    } catch (e) {\n      error = e;\n    }\n\n    // if request did not succeed, show error on the current form\n    if (error) {\n      await this.showFormErrors(this.formView.model, error, this.formView.form);\n      return;\n    }\n\n    // process response, may render a new form\n    await this.handleIdxResponse(resp);\n  },\n\n  // eslint-disable-next-line max-statements, complexity\n  async handleSaveForm(model) {\n    const formName = model.get('formName');\n\n    // Toggle Form saving status (e.g. disabling save button, etc)\n    this.toggleFormButtonState(true);\n    model.trigger('request');\n\n    // Use full page redirection if necessary\n    if (model.get('useRedirect')) {\n      // Clear when navigates away from SIW page, e.g. success, IdP Authenticator.\n      // Because SIW sort of finished its current /transaction/\n      sessionStorageHelper.removeStateHandle();\n\n      // OKTA-635926: do not redirect without user gesture for ov enrollment on android\n      // if Util.isAndroidOVEnrollment() returns true we use a user gesture to complete the redirect in AutoRedirectView\n      if (!Util.isAndroidOVEnrollment()) {\n        const currentViewState = this.options.appState.getCurrentViewState();\n        Util.redirectWithFormGet(currentViewState.href);\n      }\n\n      return;\n    }\n\n    const payload = transformPayload(formName, model);\n    // Run hook: transform the user name (a.k.a identifier)\n    const values = this.transformIdentifier(formName, payload);\n\n    // widget rememberMe feature stores the entered identifier in a cookie, to pre-fill the form on subsequent visits to page\n    if (this.options.settings.get('features.rememberMe')) {\n      if (values.identifier) {\n        CookieUtil.setUsernameCookie(values.identifier);\n      }\n    }\n    else {\n      CookieUtil.removeUsernameCookie();\n    }\n\n    // Error out when this is not a remediation form. Unexpected Exception.\n    if (!this.options.appState.hasRemediationObject(formName)) {\n      this.options.settings.callGlobalError(`Cannot find http action for \"${formName}\".`);\n      await this.showFormErrors(this.formView.model, 'Cannot find action to proceed.', this.formView.form);\n      return;\n    }\n\n    // Reset password in identity-first flow needs some help to auto-select password and begin the reset flow\n    if (formName === 'identify' && this.options.settings.get('flow') === CONFIGURED_FLOW.RESET_PASSWORD) {\n      values.authenticator = 'okta_password';\n    }\n\n    // Submit request to idx endpoint\n    const authClient = this.options.settings.getAuthClient();\n    const idxOptions: ProceedOptions = {\n      exchangeCodeForTokens: false, // we handle this in interactionCodeFlow.js\n    };\n    try {\n      const idx = this.options.appState.get('idx');\n      const { stateHandle } = idx.context;\n      const resp = await authClient.idx.proceed({\n        ...idxOptions,\n        step: formName,\n        stateHandle,\n        ...values\n      });\n\n      if (resp.status === IdxStatus.FAILURE) {\n        throw resp.error; // caught and handled in this function\n      }\n      // follow idx transaction to render terminal view for session expired error\n      if (IonResponseHelper.isIdxSessionExpiredError(resp)) {\n        const authClient = this.settings.getAuthClient();\n        authClient.transactionManager.clear();\n        await this.handleIdxResponse(resp);\n        return;\n      }\n      // If the last request did not succeed, show errors on the current form\n      // Special case: Okta server responds 401 status code with WWW-Authenticate header and new remediation\n      // so that the iOS/MacOS credential SSO extension (Okta Verify) can intercept\n      // the response reaches here when Okta Verify is not installed\n      // we need to return an idx object so that\n      // the SIW can proceed to the next step without showing error\n      if (resp.requestDidSucceed === false && !resp.stepUp) {\n        await this.showFormErrors(model, resp, this.formView.form);\n        return;\n      }\n      const onSuccess = this.handleIdxResponse.bind(this, resp);\n      if (formName === FORMS.ENROLL_PROFILE) {\n        // call registration (aka enroll profile) hook\n        this.settings.postRegistrationSubmit(values?.userProfile?.email, onSuccess, (error) => {\n          model.trigger('error', model, {\n            responseJSON: error,\n          });\n        });\n      } else {\n        await onSuccess();\n      }\n    } catch(error) {\n      if (error.is?.('terminal')) {\n        this.options.appState.setNonIdxError(error);\n      } else {\n        await this.showFormErrors(model, error, this.formView.form);\n      }\n    } finally {\n      this.toggleFormButtonState(false);\n    }\n  },\n\n  transformIdentifier(formName, modelJSON) {\n    if (Object.prototype.hasOwnProperty.call(modelJSON, 'identifier')) {\n      // The callback function is passed two arguments:\n      // 1) username: The name entered by the user\n      // 2) operation: The type of operation the user is trying to perform:\n      //      - PRIMARY_AUTH\n      //      - FORGOT_PASSWORD\n      //      - UNLOCK_ACCOUNT\n      const operation = FORM_NAME_TO_OPERATION_MAP[formName];\n      modelJSON.identifier = this.settings.transformUsername(modelJSON.identifier, operation);\n    }\n    return modelJSON;\n  },\n\n  /**\n   * @param model current form model\n   * @param error any errors after user action\n   * @param form current form\n   * Handle errors that get displayed right after any user action. After such form errors widget doesn't\n   * reload or re-render, but updates the AppSate with latest remediation.\n   */\n  async showFormErrors(model, error, form) {\n    /* eslint max-statements: [2, 24] */\n    let errorObj;\n    let idxStateError;\n    let showErrorBanner = true;\n    model.trigger('clearFormError');\n\n    if (!error) {\n      error = 'FormController - unknown error found';\n      this.options.settings.callGlobalError(error);\n    }\n\n    if(error?.rawIdxState) {\n      idxStateError = error;\n      error = error.rawIdxState;\n    }\n\n    if (IonResponseHelper.isIonErrorResponse(error)) {\n      errorObj = IonResponseHelper.convertFormErrors(error);\n    } else if (error.errorSummary) {\n      errorObj = { responseJSON: error };\n    } else {\n      Util.logConsoleError(error);\n      errorObj = { responseJSON: { errorSummary: loc('error.unsupported.response', 'login')}};\n    }\n\n    if(_.isFunction(form?.showCustomFormErrorCallout)) {\n      showErrorBanner = !form.showCustomFormErrorCallout(errorObj, idxStateError.messages);\n    }\n\n    // show error before updating app state.\n    model.trigger('error', model, errorObj, showErrorBanner);\n    idxStateError = Object.assign({}, idxStateError, {hasFormError: true});\n\n    // TODO OKTA-408410: Widget should update the state on every new response. It should NOT do selective update.\n    // For eg 429 rate-limit errors, we have to skip updating idx state, because error response is not an idx response.\n    if (Array.isArray(idxStateError?.neededToProceed) && idxStateError?.neededToProceed.length) {\n      await this.handleIdxResponse(idxStateError);\n    }\n  },\n\n  async handleIdxResponse(idxResp) {\n    await updateAppState(this.options.appState, idxResp);\n  },\n\n  /**\n   * SignIn widget has its own (hacky) way to customize the button disabled state:\n   * adding `link-button-disabled` despite the name was intend only to disable\n   * `link-button`.\n   * Instead of doing decent refactor, we want to follow the convention for now.\n   *\n   * @param {boolean} disabled whether add extra disable CSS class.\n   */\n  toggleFormButtonState: function(disabled) {\n    const button = this.$el.find('.o-form-button-bar .button');\n    button.toggleClass('link-button-disabled', disabled);\n  },\n});\n"],"names":["Controller","extend","className","appStateEvents","preRender","removeChildren","postRender","currentViewState","options","appState","getCurrentViewState","clearMetadata","formName","name","settings","get","CONFIGURED_FLOW","RESET_PASSWORD","TheView","ViewFactory","create","formView","add","last","error","callGlobalError","triggerAfterRenderEvent","TERMINAL_FORMS","includes","sessionStorageHelper","removeStateHandle","contextData","createAfterEventContext","trigger","handleFormNameChange","render","handleAfterError","errorContextData","xhr","errorSummary","responseJSON","authenticatorKey","methodType","isPasswordRecoveryFlow","v1ControllerClassName","getV1ClassName","eventData","controller","handleSwitchForm","unset","set","handleInvokeAction","actionPath","actionParams","idx","stateHandle","context","invokeOptions","exchangeCodeForTokens","getAuthClient","transactionManager","clear","clearIdxResponse","clearAppStateCache","FORMS","LAUNCH_AUTHENTICATOR","actions","params","find","item","step","_","isFunction","ConfigError","showFormErrors","model","form","invokeAction","authClient","resp","proceed","requestDidSucceed","e","handleIdxResponse","handleSaveForm","toggleFormButtonState","Util","isAndroidOVEnrollment","redirectWithFormGet","href","payload","transformPayload","values","transformIdentifier","identifier","CookieUtil","setUsernameCookie","removeUsernameCookie","hasRemediationObject","authenticator","idxOptions","status","IdxStatus","FAILURE","IonResponseHelper","isIdxSessionExpiredError","stepUp","onSuccess","bind","ENROLL_PROFILE","postRegistrationSubmit","userProfile","email","is","setNonIdxError","modelJSON","Object","prototype","hasOwnProperty","call","operation","FORM_NAME_TO_OPERATION_MAP","transformUsername","errorObj","idxStateError","showErrorBanner","rawIdxState","isIonErrorResponse","convertFormErrors","logConsoleError","loc","showCustomFormErrorCallout","messages","assign","hasFormError","Array","isArray","neededToProceed","length","idxResp","updateAppState","disabled","button","$el","toggleClass"],"mappings":"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"}
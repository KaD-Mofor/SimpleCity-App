{"version":3,"file":"AppState.js","sources":["../../../../../src/v2/models/AppState.ts"],"sourcesContent":["/*!\n * Copyright (c) 2020, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { Model, ModelProperty } from '@okta/courage';\nimport Logger from 'util/Logger';\nimport {\n  FORMS_WITHOUT_SIGNOUT,\n  FORMS_WITH_STATIC_BACK_LINK,\n  FORMS_FOR_VERIFICATION,\n  AUTHENTICATOR_KEY,\n  FORMS,\n} from '../ion/RemediationConstants';\nimport { createOVOptions } from '../ion/ui-schema/ion-object-handler';\nimport { _ } from '../mixins/mixins';\nimport { executeHooksBefore, executeHooksAfter } from 'util/Hooks';\nimport Settings from 'models/Settings';\nimport Hooks from 'models/Hooks';\nimport { RecoverableError } from 'util/OAuthErrors';\nimport { IdxRemediation } from '@okta/okta-auth-js';\nimport BrowserFeatures from 'util/BrowserFeatures';\n\nconst UNKNOWN_USER_I8N_KEY = \"idx.unknown.user\";\n/**\n * Keep track of stateMachine with this special model. Similar to `src/models/AppState.js`\n */\n\nconst local: Record<string, ModelProperty> = {\n  user: 'object',        // optional\n  currentFormName: 'string',\n  idx: 'object',\n  remediations: 'array',\n  dynamicRefreshInterval: 'number',\n  deviceFingerprint: 'string',\n  hooks: 'object' // instance of models/Hooks\n};\n\nconst derived: Record<string, ModelProperty> = {\n  authenticatorProfile: {\n    deps: ['currentAuthenticator', 'currentAuthenticatorEnrollment'],\n    fn(currentAuthenticator = { profile: undefined }, currentAuthenticatorEnrollment = { profile: undefined }) {\n      return currentAuthenticator.profile\n        || currentAuthenticatorEnrollment.profile\n        || {};\n    },\n  },\n  authenticatorKey: {\n    deps: ['currentAuthenticator', 'currentAuthenticatorEnrollment'],\n    fn(currentAuthenticator = { key: undefined }, currentAuthenticatorEnrollment = { key: undefined }) {\n      return currentAuthenticator.key\n        || currentAuthenticatorEnrollment.key\n        || '';\n    },\n  },\n  authenticatorMethodType: {\n    deps: ['currentAuthenticator', 'currentAuthenticatorEnrollment'],\n    fn(currentAuthenticator = { methods: undefined }, currentAuthenticatorEnrollment = { methods: undefined }) {\n      return currentAuthenticator.methods && currentAuthenticator.methods[0].type\n        || currentAuthenticatorEnrollment.methods && currentAuthenticatorEnrollment.methods[0].type\n        || '';\n    },\n  },\n  isPasswordRecovery: {\n    deps: ['recoveryAuthenticator'],\n    fn: function(recoveryAuthenticator = { type: undefined }) {\n      return recoveryAuthenticator?.type === 'password';\n    }\n  }\n};\n\nexport type AppStateProps = typeof local & typeof derived;\n\nexport default class AppState extends Model {\n  settings: Settings;\n  hooks: Hooks;\n  \n  constructor(attributes, options) {\n    super(attributes, options);\n    this.settings = options.settings;\n    this.hooks = options.hooks;\n  }\n\n  get<A extends Backbone._StringKey<AppStateProps>>(attributeName: A): any {\n    return Model.prototype.get.call(this, attributeName);\n  }\n\n  preinitialize(...args) {\n    this.local = local;\n    this.derived = derived;\n    Model.prototype.preinitialize.apply(this, args);\n  }\n\n  isIdentifierOnlyView() {\n    return !this.get('remediations')?.find(({ name }) => name === 'identify')\n      ?.uiSchema?.find(({ name }) => name === 'credentials.passcode');\n  }\n\n  hasRemediationObject(formName) {\n    return this.get('idx').neededToProceed.find((remediation) => remediation.name === formName);\n  }\n\n  hasActionObject(actionName) {\n    return !!this.get('idx')?.actions?.[actionName];\n  }\n\n  getRemediationAuthenticationOptions(formName) {\n    const form = this.hasRemediationObject(formName);\n    if (!form) {\n      return [];\n    }\n    const authenticator = form.value.find((value) => value.name === 'authenticator');\n    let authenticatorOptions = authenticator?.options || [];\n    // OV is a special case, so process OV options\n    authenticatorOptions = [...authenticatorOptions]; //clone it since we are changing it for OV\n    createOVOptions(authenticatorOptions);\n    return authenticatorOptions;\n  }\n\n  getActionByPath(actionPath) {\n    const paths = actionPath.split('.');\n    let targetObject;\n    if (paths.length === 1) {\n      targetObject = this.get('idx').actions;\n    } else {\n      targetObject = this.get(paths.shift());\n    }\n    // Limitation\n    // At the time of writting, action only lives in first level of state objects.\n    const actionName = paths.shift();\n    if (targetObject && _.isFunction(targetObject[actionName])) {\n      return targetObject[actionName];\n    } else {\n      return null;\n    }\n  }\n\n  getCurrentViewState() {\n    const currentFormName = this.get('currentFormName');\n\n    if (!currentFormName) {\n      return;\n    }\n\n    // didn't expect `remediations` is empty. See `setIonResponse`.\n    const currentViewState = this.get('remediations').filter(r => r.name === currentFormName)[0];\n\n    if (!currentViewState) {\n      Logger.error('Panic!!');\n      Logger.error(`\\tCannot find view state for form ${currentFormName}.`);\n      const allFormNames = this.get('remediations').map(r => r.name);\n      Logger.error(`\\tAll available form names: ${allFormNames}`);\n    }\n\n    return currentViewState;\n  }\n\n  /**\n   * Returns ui schema of the form field from current view state\n   * @param {string} fieldName\n   * @returns {}\n   */\n  getSchemaByName(fieldName) {\n    const currentViewState = this.getCurrentViewState();\n    if(currentViewState) {\n      const uiSchema = currentViewState.uiSchema;\n      return uiSchema.find(({ name }) => name === fieldName);\n    }\n  }\n\n  /**\n   * Returns the displayName of the authenticator\n   * @returns {string}\n   */\n  getAuthenticatorDisplayName() {\n    const currentAuthenticator = this.get('currentAuthenticator') || {};\n    const currentAuthenticatorEnrollment = this.get('currentAuthenticatorEnrollment') || {};\n\n    // For enrollment and certain verification flows, the currentAuthenticator object will be present.\n    // If not, we're likely in a traditional verify/challenge flow.\n    return currentAuthenticator.displayName || currentAuthenticatorEnrollment.displayName;\n  }\n\n  /**\n   * Checks to see if we're in an authenticator challenge flow.\n   * @returns {boolean}\n   */\n  isAuthenticatorChallenge() {\n    const currentFormName = this.get('currentFormName');\n    return FORMS_FOR_VERIFICATION.includes(currentFormName);\n  }\n\n  shouldReRenderView(transformedResponse) {\n    if (transformedResponse?.idx?.hasFormError) {\n      return false;\n    }\n\n    const previousRawState = this.has('idx') ? this.get('idx').rawIdxState : null;\n\n    const identicalResponse = _.isEqual(\n      _.nestedOmit(transformedResponse.idx.rawIdxState, ['expiresAt', 'refresh', 'stateHandle', 'headers']),\n      _.nestedOmit(previousRawState, ['expiresAt', 'refresh', 'stateHandle', 'headers']));\n\n    if (identicalResponse) {\n      this.set('dynamicRefreshInterval', this.getRefreshInterval(transformedResponse));\n    }\n\n    return this._isReRenderRequired(identicalResponse, transformedResponse, previousRawState);\n  }\n\n  getRefreshInterval(transformedResponse) {\n    // Only polling refresh interval has changed in the response,\n    // make sure to update the correct poll view's refresh value\n    const currentFormName = this.get('currentFormName');\n    const currentViewState = transformedResponse.remediations.filter(r => r.name === currentFormName)[0];\n    // Get new refresh interval for either: remediations, authenticator, or authenticator enrollment\n    return currentViewState.refresh ||\n      transformedResponse.currentAuthenticatorEnrollment?.poll?.refresh ||\n      transformedResponse.currentAuthenticator?.poll?.refresh;\n  }\n\n  // Sign Out link will be displayed in the footer of a form, unless:\n  // - widget configuration set hideSignOutLinkInMFA or mfaOnlyFlow to true\n  // - cancel remediation form is not present in the response\n  // - form is part of our list FORMS_WITHOUT_SIGNOUT\n  shouldShowSignOutLinkInCurrentForm(hideSignOutLinkInMFA) {\n    const idxActions = this.get('idx') && this.get('idx').actions;\n    const currentFormName = this.get('currentFormName');\n\n    return !hideSignOutLinkInMFA\n      && _.isFunction(idxActions?.cancel)\n      && !FORMS_WITHOUT_SIGNOUT.includes(currentFormName);\n  }\n\n  containsMessageWithI18nKey(keys) {\n    if (!Array.isArray(keys)) {\n      keys = [keys];\n    }\n    const messagesObjs = this.get('messages');\n    return messagesObjs && Array.isArray(messagesObjs.value)\n      && messagesObjs.value.some(messagesObj => _.contains(keys, messagesObj.i18n?.key));\n  }\n\n  containsMessageStartingWithI18nKey(keySubStr) {\n    const messagesObjs = this.get('messages');\n    return messagesObjs && Array.isArray(messagesObjs.value)\n      && messagesObjs.value.some(messagesObj => messagesObj.i18n?.key.startsWith(keySubStr));\n  }\n\n  clearAppStateCache() {\n    // clear appState before setting new values\n    const attrs = {};\n    for (const key in this.attributes) {\n      if (key !== 'currentFormName') {\n        attrs[key] = void 0;\n      }\n    }\n    this.set(attrs, Object.assign({}, { unset: true, silent: true }));\n    // clear cache for derived props.\n    this.trigger('cache:clear');\n  }\n\n  chooseRemediation(transformedResponse): IdxRemediation | undefined {\n    if (_.isEmpty(transformedResponse.remediations)) {\n      return;\n    }\n\n    const firstRemediation = transformedResponse.remediations[0];\n\n    // Special case: Okta Verify: show select enrollment channel instead of QR code on mobile\n    if (firstRemediation.name === 'enroll-poll'\n      && this.get('authenticatorKey') === AUTHENTICATOR_KEY.OV\n      && (BrowserFeatures.isAndroid() || BrowserFeatures.isIOS())\n      && transformedResponse.currentAuthenticator?.contextualData?.selectedChannel === 'qrcode'\n    ) {\n        return transformedResponse.remediations.find(r => r.name === 'select-enrollment-channel')\n    }\n\n    // Default case: return the first remediation in the list\n    return firstRemediation;\n  }\n\n  async setIonResponse(transformedResponse) {\n    const doRerender = this.shouldReRenderView(transformedResponse);\n    this.clearAppStateCache();\n    // set new app state properties\n    this.set(transformedResponse);\n\n    if (doRerender) {\n      const remediation = this.chooseRemediation(transformedResponse);\n      let currentFormName = null;\n      if (remediation) {\n        currentFormName = remediation.name;\n      } else {\n        Logger.error('Panic!!');\n        Logger.error('\\tNo remediation found.');\n        Logger.error('\\tHere is the entire response');\n        Logger.error(JSON.stringify(transformedResponse, null, 2));\n      }\n\n      const hook = this.hooks?.getHook(currentFormName); // may be undefined\n      await executeHooksBefore(hook);\n  \n      this.unset('currentFormName', { silent: true });\n      // make sure change `currentFormName` is last step.\n      // change `currentFormName` will re-render FormController,\n      // which may depend on other derived properties hence\n      // those derived properties must be re-computed before\n      // re-rendering controller.\n      this.set({ currentFormName });\n\n      await executeHooksAfter(hook);\n    }\n  }\n\n  setNonIdxError(error: RecoverableError<any>) {\n    this.set('remediations', [{ name: FORMS.TERMINAL }]);\n    this.set('messages', { value: [\n      {\n        message: error.errorDetails.errorSummary,\n        class: 'ERROR'\n      }\n    ]})\n    this.set('currentFormName', FORMS.TERMINAL);\n  }\n\n  getUser() {\n    return this.get('user');\n  }\n\n  _isReRenderRequired(identicalResponse, transformedResponse, previousRawState) {\n    let reRender = true;\n\n    const isPreviousStateError = this.get('idx')?.hasFormError;\n    if (isPreviousStateError && this._isChallengeAuthenticatorPoll(transformedResponse, previousRawState)) {\n      reRender = false;\n    }\n\n    if (identicalResponse) {\n      /**\n       * returns false: When new response is same as last.\n       * usually happens during polling when pipeline doesn't proceed to next step.\n       * expiresAt will be different for each response, hence compare objects without that property\n       */\n      reRender = false;\n      if (this.get('currentFormName') === 'poll') {\n        /**\n         * returns true: We want to force reRender when currentForm is poll because request has to reinitiate\n         * based on new refresh and UI has to reflect new timer.\n         * We dont technical poll here we just make a request after the specified refresh time each time\n         * we get a new response.\n         */\n        reRender = true;\n      } else if (FORMS_WITH_STATIC_BACK_LINK.includes(this.get('currentFormName'))) {\n        /**\n         * returns true: We want to force reRender if you go back to selection screen from challenge or enroll screen\n         * and re-select the same authenticator for challenge. In this case also new response will be identical\n         * to the old response.\n         */\n        reRender = true;\n      } else if (this.containsMessageWithI18nKey(UNKNOWN_USER_I8N_KEY)) {\n        /**\n         * Need to re-render or else form will be stuck in saving mode.\n         * This message is a form warning that can result in identical responses if the user enters the same\n         * username as the one in the last message warning.\n         */\n        reRender = true;\n      }\n    }\n\n    return reRender;\n  }\n\n  /**\n   * This is to account for the edge case introduced by this issue: OKTA-419210. With the current idx remediations,\n   * there's no good way to generalize this as the backend handles the authenticators for phone, sms and \n   * email differently. Although not ideal, we have to keep this check in for now until we find a better solution.\n   */\n  _isChallengeAuthenticatorPoll(transformedResponse, previousRawState) {\n    const isSameExceptMessages = _.isEqual(\n      _.nestedOmit(transformedResponse.idx.rawIdxState, ['expiresAt', 'refresh', 'stateHandle', 'headers']),\n      _.nestedOmit(previousRawState, ['expiresAt', 'refresh', 'stateHandle', 'messages', 'headers']));\n\n    const isChallengeAuthenticator = this.get('currentFormName') === 'challenge-authenticator';\n    const isCurrentAuthenticatorEmail = this.get('currentAuthenticatorEnrollment')?.key === AUTHENTICATOR_KEY.EMAIL;\n\n    return isSameExceptMessages && isChallengeAuthenticator && isCurrentAuthenticatorEmail;\n  }\n}\n"],"names":["UNKNOWN_USER_I8N_KEY","local","user","currentFormName","idx","remediations","dynamicRefreshInterval","deviceFingerprint","hooks","derived","authenticatorProfile","deps","fn","currentAuthenticator","profile","undefined","currentAuthenticatorEnrollment","authenticatorKey","key","authenticatorMethodType","methods","type","isPasswordRecovery","recoveryAuthenticator","AppState","Model","constructor","attributes","options","settings","get","attributeName","prototype","call","preinitialize","args","apply","isIdentifierOnlyView","find","name","uiSchema","hasRemediationObject","formName","neededToProceed","remediation","hasActionObject","actionName","actions","getRemediationAuthenticationOptions","form","authenticator","value","authenticatorOptions","createOVOptions","getActionByPath","actionPath","paths","split","targetObject","length","shift","_","isFunction","getCurrentViewState","currentViewState","filter","r","Logger","error","allFormNames","map","getSchemaByName","fieldName","getAuthenticatorDisplayName","displayName","isAuthenticatorChallenge","FORMS_FOR_VERIFICATION","includes","shouldReRenderView","transformedResponse","hasFormError","previousRawState","has","rawIdxState","identicalResponse","isEqual","nestedOmit","set","getRefreshInterval","_isReRenderRequired","refresh","poll","shouldShowSignOutLinkInCurrentForm","hideSignOutLinkInMFA","idxActions","cancel","FORMS_WITHOUT_SIGNOUT","containsMessageWithI18nKey","keys","Array","isArray","messagesObjs","some","messagesObj","contains","i18n","containsMessageStartingWithI18nKey","keySubStr","startsWith","clearAppStateCache","attrs","Object","assign","unset","silent","trigger","chooseRemediation","isEmpty","firstRemediation","AUTHENTICATOR_KEY","OV","BrowserFeatures","isAndroid","isIOS","contextualData","selectedChannel","setIonResponse","doRerender","JSON","stringify","hook","getHook","executeHooksBefore","executeHooksAfter","setNonIdxError","FORMS","TERMINAL","message","errorDetails","errorSummary","class","getUser","reRender","isPreviousStateError","_isChallengeAuthenticatorPoll","FORMS_WITH_STATIC_BACK_LINK","isSameExceptMessages","isChallengeAuthenticator","isCurrentAuthenticatorEmail","EMAIL"],"mappings":"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"}
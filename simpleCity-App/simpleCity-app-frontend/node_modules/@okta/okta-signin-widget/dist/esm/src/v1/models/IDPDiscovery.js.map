{"version":3,"file":"IDPDiscovery.js","sources":["../../../../../src/v1/models/IDPDiscovery.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2017, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { loc } from '@okta/courage';\nimport PrimaryAuthModel from 'v1/models/PrimaryAuth';\nimport CookieUtil from 'util/CookieUtil';\nimport Enums from 'util/Enums';\nimport Util from 'util/Util';\nexport default PrimaryAuthModel.extend({\n  props: function() {\n    const cookieUsername = CookieUtil.getCookieUsername();\n    const properties = this.getUsernameAndRemember(cookieUsername);\n\n    return {\n      username: ['string', true, properties.username],\n      lastUsername: ['string', false, cookieUsername],\n      context: ['object', false],\n      remember: ['boolean', true, properties.remember],\n    };\n  },\n\n  local: {},\n\n  save: function() {\n    const username = this.settings.transformUsername(this.get('username'), Enums.IDP_DISCOVERY);\n    const remember = this.get('remember');\n    const lastUsername = this.get('lastUsername');\n    const resource = 'okta:acct:' + username;\n    const requestContext = this.get('requestContext');\n\n    this.setUsernameCookie(username, remember, lastUsername);\n\n    //the 'save' event here is triggered and used in the BaseLoginController\n    //to disable the primary button\n    this.trigger('save');\n\n    this.appState.trigger('loading', true);\n\n    const webfingerArgs = {\n      resource: resource,\n      requestContext: requestContext,\n    };\n    const authClient = this.appState.settings.getAuthClient();\n\n    authClient\n      .webfinger(webfingerArgs)\n      .then(res => {\n        if (res && res.links && res.links[0]) {\n          if (res.links[0].properties['okta:idp:type'] === 'OKTA') {\n            this.trigger('goToPrimaryAuth');\n          } else if (res.links[0].href) {\n            const redirectFn = res.links[0].href.includes('OKTA_INVALID_SESSION_REPOST%3Dtrue')\n              ? Util.redirectWithFormGet.bind(Util)\n              : this.settings.get('redirectUtilFn');\n            //override redirectFn to only use Util.redirectWithFormGet if OKTA_INVALID_SESSION_REPOST is included\n            //it will be encoded since it will be included in the encoded fromURI\n\n            redirectFn(res.links[0].href);\n          }\n        }\n      })\n      .catch(() => {\n        // webfinger request might fail when corporate proxy checks if request is 'authenticated' using cookies\n        const error = {\n          errorSummary: loc('oform.error.webfinger', 'login'),\n        };\n        this.trigger('error', this, {\n          responseJSON: error,\n        });\n        // Specific event handled by the Header for the case where the security image is not\n        // enabled and we want to show a spinner. (Triggered only here and handled only by Header).\n        this.appState.trigger('removeLoading');\n        CookieUtil.removeUsernameCookie();\n      })\n      .finally(() => {\n        this.appState.trigger('loading', false);\n      });\n  },\n});\n"],"names":["PrimaryAuthModel","extend","props","cookieUsername","CookieUtil","getCookieUsername","properties","getUsernameAndRemember","username","lastUsername","context","remember","local","save","settings","transformUsername","get","Enums","IDP_DISCOVERY","resource","requestContext","setUsernameCookie","trigger","appState","webfingerArgs","authClient","getAuthClient","webfinger","then","res","links","href","redirectFn","includes","Util","redirectWithFormGet","bind","catch","error","errorSummary","loc","responseJSON","removeUsernameCookie","finally"],"mappings":"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"}
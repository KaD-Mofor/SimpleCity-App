{"version":3,"file":"VerifyCustomFactorController.js","sources":["../../../../../src/v1/controllers/VerifyCustomFactorController.js"],"sourcesContent":["/*!\n * Copyright (c) 2018-2019, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc, internal } from '@okta/courage';\nimport FactorUtil from 'util/FactorUtil';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nimport FooterMFA from 'v1/views/shared/FooterMFA';\nconst { Util } = internal.util;\nexport default FormController.extend({\n  className: 'verify-custom-factor custom-factor-form',\n\n  Model: {\n    props: {\n      rememberDevice: 'boolean',\n    },\n\n    initialize: function() {\n      const rememberDevice = FactorUtil.getRememberDeviceValue(this.appState);\n\n      // set the initial value for remember device (Cannot do this while defining the\n      // local property because this.settings would not be initialized there yet).\n      this.set('rememberDevice', rememberDevice);\n      if (this.settings.get('features.skipIdpFactorVerificationBtn') &&\n        !this.appState.get('lastFailedChallengeFactorData')) {\n        this.set('provider', 'CUSTOM');\n        this.set('factorType', 'claims_provider');\n        this.save();\n      }\n    },\n\n    save: function() {\n      const rememberDevice = !!this.get('rememberDevice');\n\n      return this.manageTransaction((transaction, setTransaction) => {\n        const data = {\n          rememberDevice: rememberDevice,\n        };\n\n        const factor = _.findWhere(transaction.factors, {\n          provider: this.get('provider'),\n          factorType: this.get('factorType'),\n        });\n\n        return factor\n          .verify(data)\n          .then(trans => {\n            setTransaction(trans);\n            const url = this.appState.get('verifyCustomFactorRedirectUrl');\n\n            if (url !== null) {\n              Util.redirect(url);\n            }\n          })\n          .catch(function(err) {\n            throw err;\n          });\n      });\n    },\n  },\n\n  Form: function() {\n    const factors = this.options.appState.get('factors');\n    const factor = factors.findWhere({\n      provider: this.options.provider,\n      factorType: this.options.factorType,\n    });\n    const vendorName = factor.get('vendorName');\n    const saveText = loc('mfa.challenge.verify', 'login');\n    const lastFailedChallengeFactorData = this.options.appState.get('lastFailedChallengeFactorData');\n    let subtitle = loc('verify.customFactor.subtitle', 'login', [vendorName]);\n\n    if (this.settings.get('features.skipIdpFactorVerificationBtn') && !lastFailedChallengeFactorData) {\n      subtitle = loc('verify.customFactor.subtitle.redirect', 'login', [vendorName]);\n\n      this.listenTo(this.model, 'error', () => {\n        subtitle = loc('verify.customFactor.subtitle', 'login', [vendorName]);\n        this.$('.o-form-explain').text(subtitle);\n      });\n    }\n    return {\n      autoSave: true,\n      title: vendorName,\n      save: saveText,\n      subtitle: subtitle,\n      attributes: { 'data-se': 'factor-custom' },\n      initialize: function() {\n        if (this.options.appState.get('allowRememberDevice')) {\n          this.addInput({\n            label: false,\n            'label-top': true,\n            placeholder: this.options.appState.get('rememberDeviceLabel'),\n            className: 'margin-btm-0',\n            name: 'rememberDevice',\n            type: 'checkbox',\n          });\n        }\n      },\n\n      formChildren: function() {\n        const result = [];\n        const lastFailedChallengeFactorData = this.options.appState.get('lastFailedChallengeFactorData');\n\n        if (this.settings.get('features.skipIdpFactorVerificationBtn') && !lastFailedChallengeFactorData) {\n          result.push(\n            FormType.View({\n              View:\n                '<div data-se=\"custom-factor-waiting\" class=\"okta-waiting-spinner\"></div>'\n            })\n          );\n        }\n\n        if (lastFailedChallengeFactorData) {\n          result.push(\n            FormType.View(\n              { View: new HtmlErrorMessageView({ message: lastFailedChallengeFactorData.errorMessage }) },\n              { selector: '.o-form-error-container' }\n            )\n          );\n        }\n        return result;\n      },\n    };\n  },\n\n  postRender() {\n    if (this.settings.get('features.skipIdpFactorVerificationBtn') &&\n      !this.options.appState.get('lastFailedChallengeFactorData')) {\n      this.$('.o-form-button-bar').hide();\n      this.$('.okta-waiting-spinner').show();\n    }\n  },\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaChallenge')) {\n      return true;\n    }\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  initialize: function() {\n    this.model.set('provider', this.options.provider);\n    this.model.set('factorType', this.options.factorType);\n\n    if (this.settings.get('features.skipIdpFactorVerificationBtn')) {\n      this.listenTo(this.model, 'error', () => {\n        this.$('.okta-waiting-spinner').hide();\n        this.$('.o-form-button-bar').show();\n      });\n    }\n    this.addFooter(FooterMFA);\n  },\n});\n"],"names":["Util","internal","util","FormController","extend","className","Model","props","rememberDevice","initialize","FactorUtil","getRememberDeviceValue","appState","set","settings","get","save","manageTransaction","transaction","setTransaction","data","factor","_","findWhere","factors","provider","factorType","verify","then","trans","url","redirect","catch","err","Form","options","vendorName","saveText","loc","lastFailedChallengeFactorData","subtitle","listenTo","model","$","text","autoSave","title","attributes","addInput","label","placeholder","name","type","formChildren","result","push","FormType","View","HtmlErrorMessageView","message","errorMessage","selector","postRender","hide","show","trapAuthResponse","back","addFooter","FooterMFA"],"mappings":"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"}
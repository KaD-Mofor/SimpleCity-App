{"version":3,"file":"EnrollmentLinkSentController.js","sources":["../../../../../src/v1/controllers/EnrollmentLinkSentController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, View, loc } from '@okta/courage';\nimport hbs from '@okta/handlebars-inline-precompile';\nimport CountryUtil from 'util/CountryUtil';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport RouterUtil from 'v1/util/RouterUtil';\nconst PUSH_INTERVAL = 6000;\n\n// Note: Keep-alive is set to 5 seconds - using 5 seconds here will result\n// in network connection lost errors in Safari and IE.\n\nconst EnrollmentLinkSentControllerFooter = View.extend({\n  template: hbs(\n    '\\\n      <a href=\"#\" class=\"link help js-back\" data-se=\"back-link\">\\\n        {{i18n code=\"oform.back\" bundle=\"login\"}}\\\n      </a>\\\n    '\n  ),\n  className: 'auth-footer',\n  events: {\n    'click .js-back': function(e) {\n      e.preventDefault();\n      this.back();\n    },\n  },\n  back: function() {\n    const url = RouterUtil.createActivateFactorUrl(\n      this.options.appState.get('activatedFactorProvider'),\n      this.options.appState.get('activatedFactorType'),\n      'manual'\n    );\n\n    this.options.appState.trigger('navigate', url);\n  },\n});\nconst emailSentForm = {\n  title: _.partial(loc, 'enroll.totp.enrollViaEmail.title', 'login'),\n  noButtonBar: true,\n  attributes: { 'data-se': 'sent-email-activation-link' },\n  formChildren: [\n    FormType.View({\n      View: View.extend({\n        template: hbs(\n          '\\\n            <p>{{i18n code=\"enroll.totp.enrollViaEmail.msg\" bundle=\"login\"}}</p>\\\n            <p class=\"email-address\">{{email}}</p>\\\n          '\n        ),\n        getTemplateData: function() {\n          return { email: this.options.appState.get('userEmail') };\n        },\n      }),\n    }),\n  ],\n};\nconst smsSentForm = {\n  title: _.partial(loc, 'enroll.totp.enrollViaSms.title', 'login'),\n  noButtonBar: true,\n  attributes: { 'data-se': 'sent-sms-activation-link' },\n  formChildren: [\n    FormType.View({\n      View: View.extend({\n        template: hbs(\n          '\\\n            <p>{{i18n code=\"enroll.totp.enrollViaSms.msg\" bundle=\"login\"}}</p>\\\n            <p class=\"phone-number\">{{phoneNumber}}</p>\\\n          '\n        ),\n        getTemplateData: function() {\n          return { phoneNumber: this.model.get('fullPhoneNumber') };\n        },\n      }),\n    }),\n  ],\n};\nexport default FormController.extend({\n  className: 'enroll-activation-link-sent',\n  Model: function() {\n    return {\n      local: {\n        countryCode: ['string', false, this.options.appState.get('userCountryCode')],\n        phoneNumber: ['string', false, this.options.appState.get('userPhoneNumber')],\n        __factorType__: ['string', false, this.options.factorType],\n        __provider__: ['string', false, this.options.provider],\n      },\n      derived: {\n        countryCallingCode: {\n          deps: ['countryCode'],\n          fn: function(countryCode) {\n            return '+' + CountryUtil.getCallingCodeForCountry(countryCode);\n          },\n        },\n        fullPhoneNumber: {\n          deps: ['countryCallingCode', 'phoneNumber'],\n          fn: function(countryCallingCode, phoneNumber) {\n            return countryCallingCode + phoneNumber;\n          },\n        },\n      },\n    };\n  },\n\n  Form: function() {\n    const activationType = this.options.appState.get('factorActivationType');\n\n    switch (activationType) {\n    case 'SMS':\n      return smsSentForm;\n    case 'EMAIL':\n      return emailSentForm;\n    default:\n      throw new Error('Unknown activation option: ' + activationType);\n    }\n  },\n\n  Footer: EnrollmentLinkSentControllerFooter,\n\n  initialize: function() {\n    this.pollForEnrollment();\n  },\n\n  remove: function() {\n    return FormController.prototype.remove.apply(this, arguments);\n  },\n\n  pollForEnrollment: function() {\n    return this.model.doTransaction(function(transaction) {\n      return transaction.poll(PUSH_INTERVAL);\n    });\n  },\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isWaitingForActivation')) {\n      this.pollForEnrollment();\n      return true;\n    }\n  },\n});\n"],"names":["PUSH_INTERVAL","EnrollmentLinkSentControllerFooter","View","extend","template","className","events","e","preventDefault","back","url","RouterUtil","createActivateFactorUrl","options","appState","get","trigger","emailSentForm","title","_","partial","loc","noButtonBar","attributes","formChildren","FormType","getTemplateData","email","smsSentForm","phoneNumber","model","FormController","Model","local","countryCode","__factorType__","factorType","__provider__","provider","derived","countryCallingCode","deps","fn","CountryUtil","getCallingCodeForCountry","fullPhoneNumber","Form","activationType","Error","Footer","initialize","pollForEnrollment","remove","prototype","apply","arguments","doTransaction","transaction","poll","trapAuthResponse"],"mappings":"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"}
{"version":3,"file":"EnrollWindowsHelloController.js","sources":["../../../../../src/v1/controllers/EnrollWindowsHelloController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc } from '@okta/courage';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport webauthn from 'util/webauthn';\nimport Footer from 'v1/views/enroll-factors/Footer';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nimport Spinner from 'v1/views/shared/Spinner';\nexport default FormController.extend({\n  className: 'enroll-windows-hello',\n  Model: {\n    local: {\n      __isEnrolled__: 'boolean',\n    },\n\n    save: function() {\n      if (!webauthn.isAvailable()) {\n        return;\n      }\n\n      this.trigger('request');\n\n      if (this.get('__isEnrolled__')) {\n        return this.activate();\n      }\n\n      return this.doTransaction(function(transaction) {\n        return this._enroll(transaction);\n      });\n    },\n\n    _enroll: function(transaction) {\n      const factor = _.findWhere(transaction.factors, {\n        factorType: 'webauthn',\n        provider: 'FIDO',\n      });\n\n      return factor.enroll();\n    },\n\n    activate: function() {\n      this.set('__isEnrolled__', true);\n\n      return this.doTransaction(function(transaction) {\n        const activation = transaction.factor.activation;\n        const user = transaction.user;\n        const model = this;\n        const accountInfo = {\n          rpDisplayName: activation.rpDisplayName,\n          userDisplayName: user.profile.displayName,\n          accountName: user.profile.login,\n          userId: user.id,\n        };\n        const cryptoParams = [\n          {\n            algorithm: activation.algorithm,\n          },\n        ];\n        const challenge = activation.nonce;\n\n        return webauthn\n          .makeCredential(accountInfo, cryptoParams, challenge)\n          .then(function(creds) {\n            return transaction.activate({\n              credentialId: creds.credential.id,\n              publicKey: creds.publicKey,\n              attestation: null,\n            });\n          })\n          .catch(function(error) {\n            switch (error.message) {\n            case 'AbortError':\n            case 'NotFoundError':\n            case 'NotSupportedError':\n              model.trigger('abort', error.message);\n              return transaction;\n            }\n\n            throw error;\n          });\n      });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: _.partial(loc, 'enroll.windowsHello.title', 'login'),\n    subtitle: function() {\n      return webauthn.isAvailable() ? loc('enroll.windowsHello.subtitle', 'login') : '';\n    },\n    save: _.partial(loc, 'enroll.windowsHello.save', 'login'),\n\n    customSavingState: {\n      stop: 'abort',\n    },\n\n    modelEvents: function() {\n      if (!webauthn.isAvailable()) {\n        return {};\n      }\n\n      return {\n        request: '_startEnrollment',\n        error: '_stopEnrollment',\n        abort: '_stopEnrollment',\n      };\n    },\n\n    noButtonBar: function() {\n      return !webauthn.isAvailable();\n    },\n\n    formChildren: function() {\n      const result = [];\n\n      if (!webauthn.isAvailable()) {\n        result.push(\n          FormType.View(\n            { View: new HtmlErrorMessageView({ message: loc('enroll.windowsHello.error.notWindows', 'login') }) },\n            { selector: '.o-form-error-container' }\n          )\n        );\n      }\n\n      result.push(FormType.View({ View: new Spinner({ model: this.model, visible: false }) }));\n\n      return result;\n    },\n\n    _startEnrollment: function() {\n      this.subtitle = loc('enroll.windowsHello.subtitle.loading', 'login');\n\n      this.model.trigger('spinner:show');\n      this._resetErrorMessage();\n\n      this.render();\n      this.$('.o-form-button-bar').addClass('hide');\n    },\n\n    _stopEnrollment: function(errorMessage) {\n      this.subtitle = loc('enroll.windowsHello.subtitle', 'login');\n\n      this.model.trigger('spinner:hide');\n\n      let message;\n\n      switch (errorMessage) {\n      case 'NotSupportedError':\n        message = loc('enroll.windowsHello.error.notConfiguredHtml', 'login');\n        break;\n      }\n\n      this._resetErrorMessage();\n\n      if (message) {\n        const messageView = new HtmlErrorMessageView({\n          message: message,\n        });\n\n        this.$('.o-form-error-container').addClass('o-form-has-errors');\n        this.add(messageView, { selector: '.o-form-error-container' });\n        this._errorMessageView = this.last();\n      }\n\n      this.render();\n      this.$('.o-form-button-bar').removeClass('hide');\n    },\n\n    _resetErrorMessage: function() {\n      this._errorMessageView && this._errorMessageView.remove();\n      this._errorMessageView = undefined;\n      this.clearErrors();\n    },\n  },\n\n  Footer: Footer,\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaEnrollActivate')) {\n      this.model.activate();\n      return true;\n    }\n  },\n});\n"],"names":["FormController","extend","className","Model","local","__isEnrolled__","save","webauthn","isAvailable","trigger","get","activate","doTransaction","transaction","_enroll","factor","_","findWhere","factors","factorType","provider","enroll","set","activation","user","model","accountInfo","rpDisplayName","userDisplayName","profile","displayName","accountName","login","userId","id","cryptoParams","algorithm","challenge","nonce","makeCredential","then","creds","credentialId","credential","publicKey","attestation","catch","error","message","Form","autoSave","hasSavingState","title","partial","loc","subtitle","customSavingState","stop","modelEvents","request","abort","noButtonBar","formChildren","result","push","FormType","View","HtmlErrorMessageView","selector","Spinner","visible","_startEnrollment","_resetErrorMessage","render","$","addClass","_stopEnrollment","errorMessage","messageView","add","_errorMessageView","last","removeClass","remove","undefined","clearErrors","Footer","trapAuthResponse","options","appState"],"mappings":"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"}
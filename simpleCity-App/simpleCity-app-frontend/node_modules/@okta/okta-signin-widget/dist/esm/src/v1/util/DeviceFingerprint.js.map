{"version":3,"file":"DeviceFingerprint.js","sources":["../../../../../src/v1/util/DeviceFingerprint.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { $ } from '@okta/courage';\nimport Q from 'q';\nexport default {\n  getUserAgent: function() {\n    return navigator.userAgent;\n  },\n  isMessageFromCorrectSource: function($iframe, event) {\n    return event.source === $iframe[0].contentWindow;\n  },\n  generateDeviceFingerprint: function(oktaDomainUrl, element) {\n    const userAgent = this.getUserAgent();\n\n    if (!userAgent) {\n      return Q.reject('user agent is not defined');\n    } else if (isWindowsPhone(userAgent)) {\n      return Q.reject('device fingerprint is not supported on Windows phones');\n    }\n\n    const deferred = Q.defer();\n    const self = this;\n    let $iframe;\n    let iFrameTimeout;\n\n    function isWindowsPhone(userAgent) {\n      return userAgent.match(/windows phone|iemobile|wpdesktop/i);\n    }\n\n    function removeIframe() {\n      $iframe.off();\n      $iframe.remove();\n      window.removeEventListener('message', onMessageReceivedFromOkta, false);\n    }\n\n    function handleError(reason) {\n      removeIframe();\n      deferred.reject(reason);\n    }\n\n    function onMessageReceivedFromOkta(event) {\n      if (!self.isMessageFromCorrectSource($iframe, event)) {\n        return;\n      }\n      // deviceFingerprint service is available, clear timeout\n      clearTimeout(iFrameTimeout);\n      if (!event || !event.data || event.origin !== oktaDomainUrl) {\n        handleError('no data');\n        return;\n      }\n      try {\n        const message = JSON.parse(event.data);\n\n        if (message && message.type === 'FingerprintServiceReady') {\n          sendMessageToOkta({ type: 'GetFingerprint' });\n        } else if (message && message.type === 'FingerprintAvailable') {\n          removeIframe();\n          deferred.resolve(message.fingerprint);\n        } else {\n          handleError('no data');\n        }\n      } catch (error) {\n        //Ignore any errors since we could get other messages too\n      }\n    }\n\n    function sendMessageToOkta(message) {\n      const win = $iframe[0].contentWindow;\n\n      if (win) {\n        win.postMessage(JSON.stringify(message), oktaDomainUrl);\n      }\n    }\n\n    // Attach listener\n    window.addEventListener('message', onMessageReceivedFromOkta, false);\n    // Create and Load devicefingerprint page inside the iframe\n    $iframe = $('<iframe>', {\n      css: {\n        display: 'none'\n      },\n      src: oktaDomainUrl + '/auth/services/devicefingerprint',\n    });\n    element.append($iframe);\n\n    iFrameTimeout = setTimeout(() => {\n      // If the iFrame does not load, throw an error\n      handleError('service not available');\n    }, 2000);\n\n    return deferred.promise;\n  },\n};\n"],"names":["getUserAgent","navigator","userAgent","isMessageFromCorrectSource","$iframe","event","source","contentWindow","generateDeviceFingerprint","oktaDomainUrl","element","Q","reject","isWindowsPhone","deferred","defer","self","iFrameTimeout","match","removeIframe","off","remove","window","removeEventListener","onMessageReceivedFromOkta","handleError","reason","clearTimeout","data","origin","message","JSON","parse","type","sendMessageToOkta","resolve","fingerprint","error","win","postMessage","stringify","addEventListener","$","css","display","src","append","setTimeout","promise"],"mappings":"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"}
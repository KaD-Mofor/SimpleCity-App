{"version":3,"file":"VerifyWindowsHelloController.js","sources":["../../../../../src/v1/controllers/VerifyWindowsHelloController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc } from '@okta/courage';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport webauthn from 'util/webauthn';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nimport FooterMFA from 'v1/views/shared/FooterMFA';\nimport Spinner from 'v1/views/shared/Spinner';\nexport default FormController.extend({\n  className: 'mfa-verify verify-windows-hello',\n  Model: {\n    local: {\n      __autoTriggered__: 'boolean',\n    },\n\n    save: function() {\n      if (!webauthn.isAvailable()) {\n        return;\n      }\n\n      this.trigger('request');\n      const model = this;\n\n      return this.doTransaction(function(transaction) {\n        const factor = _.findWhere(transaction.factors, {\n          factorType: 'webauthn',\n          provider: 'FIDO',\n        });\n\n        return factor.verify().then(function(verifyData) {\n          const factorData = verifyData.factor;\n\n          return webauthn\n            .getAssertion(factorData.challenge.nonce, [{ id: factorData.profile.credentialId }])\n            .then(function(assertion) {\n              return factor.verify({\n                authenticatorData: assertion.authenticatorData,\n                clientData: assertion.clientData,\n                signatureData: assertion.signature,\n              });\n            })\n            .then(function(data) {\n              model.trigger('sync');\n              model.trigger('signIn');\n              return data;\n            })\n            .catch(function(error) {\n              switch (error.message) {\n              case 'AbortError':\n              case 'NotFoundError':\n              case 'NotSupportedError':\n                model.trigger('abort', error.message);\n                return transaction;\n              }\n\n              throw error;\n            });\n        });\n      });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: _.partial(loc, 'factor.windowsHello', 'login'),\n    subtitle: function() {\n      return webauthn.isAvailable() ? loc('verify.windowsHello.subtitle', 'login') : '';\n    },\n    save: _.partial(loc, 'verify.windowsHello.save', 'login'),\n\n    customSavingState: {\n      stop: 'abort',\n    },\n\n    modelEvents: function() {\n      if (!webauthn.isAvailable()) {\n        return {};\n      }\n\n      return {\n        request: '_startEnrollment',\n        error: '_stopEnrollment',\n        abort: '_stopEnrollment',\n        signIn: '_successEnrollment',\n      };\n    },\n\n    noButtonBar: function() {\n      return !webauthn.isAvailable();\n    },\n\n    formChildren: function() {\n      const result = [];\n\n      if (!webauthn.isAvailable()) {\n        result.push(\n          FormType.View(\n            { View: new HtmlErrorMessageView({ message: loc('enroll.windowsHello.error.notWindows', 'login') }) },\n            { selector: '.o-form-error-container' }\n          )\n        );\n      }\n\n      result.push(FormType.View({ View: new Spinner({ model: this.model, visible: false }) }));\n\n      return result;\n    },\n\n    postRender: function() {\n      if (this.options.appState.get('factors').length === 1 && !this.model.get('__autoTriggered__')) {\n        this.model.set('__autoTriggered__', true);\n        this.model.save();\n      }\n    },\n\n    _startEnrollment: function() {\n      this.subtitle = loc('verify.windowsHello.subtitle.loading', 'login');\n\n      this.model.trigger('spinner:show');\n      this._resetErrorMessage();\n\n      this.render();\n      this.$('.o-form-button-bar').addClass('hide');\n    },\n\n    _stopEnrollment: function(errorMessage) {\n      this.subtitle = loc('verify.windowsHello.subtitle', 'login');\n\n      this.model.trigger('spinner:hide');\n      this.$('.o-form-button-bar').removeClass('hide');\n\n      let message;\n\n      switch (errorMessage) {\n      case 'NotFoundError':\n        message = this.options.appState.get('factors').length > 1\n          ? loc('verify.windowsHello.error.notFound.selectAnother', 'login')\n          : loc('verify.windowsHello.error.notFound', 'login');\n        break;\n\n      case 'NotSupportedError':\n        message = loc('enroll.windowsHello.error.notConfiguredHtml', 'login');\n        break;\n      }\n\n      this._resetErrorMessage();\n\n      if (message) {\n        const messageView = new HtmlErrorMessageView({\n          message: message,\n        });\n\n        this.$('.o-form-error-container').addClass('o-form-has-errors');\n        this.add(messageView, { selector: '.o-form-error-container' });\n        this._errorMessageView = this.last();\n      }\n\n      this.render();\n    },\n\n    _successEnrollment: function() {\n      this.subtitle = this.settings.get('brandName')\n        ? loc('verify.windowsHello.subtitle.signingIn.specific', 'login', [this.settings.get('brandName')])\n        : loc('verify.windowsHello.subtitle.signingIn.generic', 'login');\n      this.render();\n      this.$('.o-form-button-bar').addClass('hide');\n    },\n\n    _resetErrorMessage: function() {\n      this._errorMessageView && this._errorMessageView.remove();\n      this._errorMessageView = undefined;\n      this.clearErrors();\n    },\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  Footer: FooterMFA,\n});\n"],"names":["FormController","extend","className","Model","local","__autoTriggered__","save","webauthn","isAvailable","trigger","model","doTransaction","transaction","factor","_","findWhere","factors","factorType","provider","verify","then","verifyData","factorData","getAssertion","challenge","nonce","id","profile","credentialId","assertion","authenticatorData","clientData","signatureData","signature","data","catch","error","message","Form","autoSave","hasSavingState","title","partial","loc","subtitle","customSavingState","stop","modelEvents","request","abort","signIn","noButtonBar","formChildren","result","push","FormType","View","HtmlErrorMessageView","selector","Spinner","visible","postRender","options","appState","get","length","set","_startEnrollment","_resetErrorMessage","render","$","addClass","_stopEnrollment","errorMessage","removeClass","messageView","add","_errorMessageView","last","_successEnrollment","settings","remove","undefined","clearErrors","back","Footer","FooterMFA"],"mappings":"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"}
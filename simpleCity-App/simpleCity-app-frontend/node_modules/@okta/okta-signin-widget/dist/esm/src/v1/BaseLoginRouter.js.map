{"version":3,"file":"BaseLoginRouter.js","sources":["../../../../src/v1/BaseLoginRouter.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint max-params: [2, 16], max-statements: [2, 20] */\n// BaseLoginRouter contains the more complicated router logic - rendering/\n// transition, etc. Most router changes should happen in LoginRouter (which is\n// responsible for adding new routes)\nimport { _, $, Backbone, Router, loc } from '@okta/courage';\nimport AppState from 'v1/models/AppState';\nimport Settings from 'models/Settings';\nimport Bundles from 'util/Bundles';\nimport Logger from 'util/Logger';\nimport AuthContainer from 'v1/views/shared/AuthContainer';\nimport Header from 'v1/views/shared/Header';\nimport SecurityBeacon from 'v1/views/shared/SecurityBeacon';\nimport Animations from 'util/Animations';\nimport BrowserFeatures from 'util/BrowserFeatures';\nimport ColorsUtil from 'util/ColorsUtil';\nimport Enums from 'util/Enums';\nimport { ConfigError } from 'util/Errors';\nimport RouterUtil from 'v1/util/RouterUtil';\nimport Util from 'util/Util';\nimport LanguageUtil from 'util/LanguageUtil';\n\nfunction isStateLessRouteHandler(router, fn) {\n  return _.find(router.stateLessRouteHandlers, function(routeName) {\n    return fn === router[routeName];\n  });\n}\n\nfunction beaconIsAvailable(Beacon, settings) {\n  if (!Beacon) {\n    return false;\n  }\n  if (Beacon === SecurityBeacon) {\n    return settings.get('features.securityImage');\n  }\n  return true;\n}\n\nexport default Router.extend({\n  Events: Backbone.Events,\n\n  initialize: function(options) {\n    // Create a default success and/or error handler if\n    // one is not provided.\n    if (!options.globalSuccessFn) {\n      options.globalSuccessFn = function() {};\n    }\n    if (!options.globalErrorFn) {\n      options.globalErrorFn = function(err) {\n        Logger.error(err);\n      };\n    }\n\n    this.settings = new Settings(_.omit(options, 'el'), { parse: true });\n\n    if (!options.el) {\n      this.settings.callGlobalError(new ConfigError(loc('error.required.el')));\n    }\n\n    $('body > div').on('click', function() {\n      // OKTA-69769 Tooltip wont close on iPhone/iPad\n      // Registering a click handler on the first div\n      // allows a tap that falls outside the tooltip\n      // to be registered as a tap by iOS\n      // and then the open tooltip will lose focus and close.\n    });\n\n    this.appState = new AppState(\n      {\n        baseUrl: this.settings.get('baseUrl'),\n        settings: this.settings,\n      },\n      { parse: true }\n    );\n\n    const wrapper = new AuthContainer({ appState: this.appState });\n\n    $(options.el).append(wrapper.render().$el);\n    this.el = `#${Enums.WIDGET_CONTAINER_ID}`;\n\n    this.header = new Header({\n      el: this.el,\n      appState: this.appState,\n      settings: this.settings,\n    });\n\n    // Hide until unitial render\n    this.hide();\n\n    this.listenTo(this.appState, 'change:transactionError', function(appState, err) {\n      RouterUtil.routeAfterAuthStatusChangeError(this, err);\n    });\n\n    this.listenTo(this.appState, 'change:transaction', function(appState, trans) {\n      RouterUtil.routeAfterAuthStatusChange(this, trans.data);\n    });\n\n    this.listenTo(this.appState, 'navigate', function(url) {\n      this.navigate(url, { trigger: true });\n    });\n  },\n\n  execute: function(cb, args) {\n    const recoveryToken = this.settings.get('recoveryToken');\n    // Recovery flow with a token passed through widget settings\n\n    if (recoveryToken) {\n      this.settings.unset('recoveryToken');\n      this.navigate(RouterUtil.createRecoveryUrl(recoveryToken), { trigger: true });\n      return;\n    }\n\n    // Refresh flow with a stateToken passed through widget settings\n    const stateToken = this.settings.get('stateToken');\n\n    if (stateToken) {\n      this.settings.unset('stateToken');\n      this.navigate(RouterUtil.createRefreshUrl(stateToken), { trigger: true });\n      return;\n    }\n\n    // Normal flow - we've either navigated to a stateless page, or are\n    // in the middle of an auth flow\n    const trans = this.appState.get('transaction');\n\n    if ((trans && trans.data) || isStateLessRouteHandler(this, cb)) {\n      cb.apply(this, args);\n      return;\n    }\n\n    // StateToken cookie exists on page load, and we are on a stateful url\n    if (this.settings.getAuthClient().tx.exists()) {\n      this.navigate(RouterUtil.createRefreshUrl(), { trigger: true });\n      return;\n    }\n\n    // We've hit a page that requires state, but have no stateToken - redirect\n    // back to primary auth\n    this.navigate('', { trigger: true });\n  },\n\n  // Overriding the default navigate method to allow the widget consumer\n  // to \"turn off\" routing - if features.router is false, the browser\n  // location bar will not update when the router navigates\n  navigate: function(fragment, options) {\n    if (this.settings.get('features.router')) {\n      return Router.prototype.navigate.apply(this, arguments);\n    }\n    if (options && options.trigger) {\n      return Backbone.history.loadUrl(fragment);\n    }\n  },\n\n  render: function(Controller, options) {\n    options || (options = {});\n\n    let Beacon = options.Beacon;\n\n    const controllerOptions = _.extend({ settings: this.settings, appState: this.appState }, _.omit(options, 'Beacon'));\n\n    // Since we have a wrapper view, render our wrapper and use its content\n    // element as our new el.\n    // Note: Render it here because we know dom is ready at this point\n    if (!this.header.rendered()) {\n      this.el = this.header.render().getContentEl();\n    }\n\n    // If we need to load a language (or apply custom i18n overrides), do\n    // this now and re-run render after it's finished.\n    if (!Bundles.isLoaded(this.appState.get('languageCode'))) {\n      return LanguageUtil.loadLanguage(this.appState, this.settings)\n        .then(_.bind(this.render, this, Controller, options));\n    }\n\n    // Load the custom colors only on the first render\n    if (this.settings.get('colors.brand') && !ColorsUtil.isLoaded()) {\n      const colors = {\n        brand: this.settings.get('colors.brand'),\n      };\n      const cspNonce = this.settings.get('cspNonce');\n\n      ColorsUtil.addStyle(colors, cspNonce);\n    }\n\n    const oldController = this.controller;\n\n    this.controller = new Controller(controllerOptions);\n\n    // Bubble up all controller events\n    this.listenTo(this.controller, 'all', this.trigger);\n\n    // First run fetchInitialData, in case the next controller needs data\n    // before it's initial render. This will leave the current page in a\n    // loading state.\n    return this.controller\n      .fetchInitialData()\n      .then(() => {\n        // Beacon transition occurs in parallel to page swap\n        if (!beaconIsAvailable(Beacon, this.settings)) {\n          Beacon = null;\n        }\n        this.header.setBeacon(Beacon, controllerOptions);\n\n        // Show before initial render\n        this.show();\n\n        this.controller.render();\n\n        if (!oldController) {\n          this.el.append(this.controller.el);\n          this.controller.postRenderAnimation();\n          return;\n        }\n\n        return Animations.swapPages({\n          $parent: this.el,\n          $oldRoot: oldController.$el,\n          $newRoot: this.controller.$el,\n          dir: oldController.state.get('navigateDir'),\n          ctx: this,\n          success: function() {\n            const flashError = this.appState.get('flashError');\n            const model = this.controller.model;\n\n            oldController.remove();\n            oldController.$el.remove();\n            this.controller.postRenderAnimation();\n            if (flashError) {\n              let errorSummary;\n              const isTerminalError = flashError.is && flashError.is('terminal');\n              if (isTerminalError) {\n                errorSummary = flashError.errorDetails.errorSummary;\n              } else {\n                errorSummary = loc((this.settings.get('features.mfaOnlyFlow')) ?\n                  'error.mfa.only.expired.session' : 'error.expired.session');\n              }\n              model.trigger('error', model, {\n                responseJSON: {\n                  errorSummary\n                },\n              });\n              this.appState.unset('flashError');\n              Util.triggerAfterError(this.controller, flashError);\n            }\n          },\n        });\n      })\n      .catch(function() {\n        // OKTA-69665 - if an error occurs in fetchInitialData, we're left in\n        // a state with two active controllers. Therefore, we clean up the\n        // old one. Note: This explicitly handles the invalid token case -\n        // if we get some other type of error which doesn't force a redirect,\n        // we will probably be left in a bad state. I.e. old controller is\n        // dropped and new controller is not rendered.\n        if (oldController) {\n          oldController.remove();\n          oldController.$el.remove();\n        }\n      });\n  },\n\n  start: function() {\n    let pushState = false;\n\n    // Support for browser's back button.\n    if (window.addEventListener && this.settings.get('features.router')) {\n      window.addEventListener('popstate', e => {\n        if (this.controller.back) {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          this.controller.back();\n        }\n      });\n      pushState = BrowserFeatures.supportsPushState();\n    }\n    Router.prototype.start.call(this, { pushState: pushState });\n  },\n\n  hide: function() {\n    this.header.$el.hide();\n  },\n\n  show: function() {\n    this.header.$el.show();\n  },\n\n  remove: function() {\n    if (this.controller) {\n      this.controller.remove();\n    }\n    this.header.$el.remove();\n    Bundles.remove();\n    Backbone.history.stop();\n  },\n});\n"],"names":["isStateLessRouteHandler","router","fn","_","find","stateLessRouteHandlers","routeName","beaconIsAvailable","Beacon","settings","SecurityBeacon","get","Router","extend","Events","Backbone","initialize","options","globalSuccessFn","globalErrorFn","err","Logger","error","Settings","omit","parse","el","callGlobalError","ConfigError","loc","$","on","appState","AppState","baseUrl","wrapper","AuthContainer","append","render","$el","Enums","WIDGET_CONTAINER_ID","header","Header","hide","listenTo","RouterUtil","routeAfterAuthStatusChangeError","trans","routeAfterAuthStatusChange","data","url","navigate","trigger","execute","cb","args","recoveryToken","unset","createRecoveryUrl","stateToken","createRefreshUrl","apply","getAuthClient","tx","exists","fragment","prototype","arguments","history","loadUrl","Controller","controllerOptions","rendered","getContentEl","Bundles","isLoaded","LanguageUtil","loadLanguage","then","bind","ColorsUtil","colors","brand","cspNonce","addStyle","oldController","controller","fetchInitialData","setBeacon","show","postRenderAnimation","Animations","swapPages","$parent","$oldRoot","$newRoot","dir","state","ctx","success","flashError","model","remove","errorSummary","isTerminalError","is","errorDetails","responseJSON","Util","triggerAfterError","catch","start","pushState","window","addEventListener","e","back","preventDefault","stopImmediatePropagation","BrowserFeatures","supportsPushState","call","stop"],"mappings":"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"}
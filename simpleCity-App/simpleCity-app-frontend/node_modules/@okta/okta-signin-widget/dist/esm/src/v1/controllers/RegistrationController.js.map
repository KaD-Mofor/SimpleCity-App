{"version":3,"file":"RegistrationController.js","sources":["../../../../../src/v1/controllers/RegistrationController.js"],"sourcesContent":["/*!\n * Copyright (c) 2017, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\nimport { _, Backbone, Model, loc, Form, View } from '@okta/courage';\nimport hbs from '@okta/handlebars-inline-precompile';\nimport LoginModel from 'v1/models/LoginModel';\nimport RegistrationSchema from 'v1/models/RegistrationSchema';\nimport Q from 'q';\nimport BaseLoginController from 'v1/util/BaseLoginController';\nimport Enums from 'util/Enums';\nimport { RegistrationError } from 'util/Errors';\nimport RegistrationFormFactory from 'v1/util/RegistrationFormFactory';\nimport Util from 'util/Util';\nimport SubSchema from 'v1/views/registration/SubSchema';\nconst RegistrationControllerFooter = View.extend({\n  template: hbs(\n    '\\\n      <a href=\"#\" class=\"link help\" data-se=\"back-link\">\\\n        {{i18n code=\"goback\" bundle=\"login\"}}\\\n      </a>\\\n    '\n  ),\n  className: 'auth-footer',\n  events: {\n    'click .help': function(e) {\n      e.preventDefault();\n      this.back();\n    },\n  },\n  back: function() {\n    this.state.set('navigateDir', Enums.DIRECTION_BACK);\n    this.options.appState.trigger('navigate', '');\n  },\n});\nexport default BaseLoginController.extend({\n  className: 'registration',\n  initialize: function() {\n    const RegistrationControllerSchema = RegistrationSchema.extend({\n      settings: this.options.settings,\n      url: this.options.settings.get('baseUrl') + '/api/v1/registration/form',\n    });\n    // setup schema\n\n    const schema = new RegistrationControllerSchema();\n\n    this.state.set('schema', schema);\n  },\n  getRegistrationApiUrl: function() {\n    const defaultPolicyId = this.settings.get('defaultPolicyId');\n    // default policyId\n\n    const orgPolicyId = this.options.settings.get('policyId');\n    // org policyId\n\n    const apiUrl = defaultPolicyId\n      ? this.getRegistrationPolicyApi(defaultPolicyId)\n      : this.getRegistrationPolicyApi(orgPolicyId);\n\n    return apiUrl;\n  },\n  getRegistrationPolicyApi: function(policyId) {\n    return this.options.settings.get('baseUrl') + '/api/v1/registration/' + policyId;\n  },\n  doPostSubmit: function() {\n    if (this.model.get('activationToken')) {\n      const self = this;\n      // register via activation token\n\n      self.settings.callGlobalSuccess(Enums.REGISTRATION_COMPLETE, {\n        activationToken: this.model.get('activationToken'),\n      });\n\n      const loginModel = new LoginModel({\n        settings: self.model.appState.settings,\n      });\n\n      loginModel.loginWithActivationToken(this.model.get('activationToken')).then(function(transaction) {\n        self.model.trigger('setTransaction', transaction);\n      });\n    } else {\n      // register via activation email\n      this.model.appState.set('username', this.model.get('email'));\n      this.model.appState.trigger('navigate', 'signin/register-complete');\n    }\n  },\n  registerUser: function(postData) {\n    const self = this;\n\n    Object.keys(postData).forEach((k) =>\n      (_.isNull(postData[k]) || _.isUndefined(postData[k]) || postData[k] === '') && delete postData[k]);\n    this.model.attributes = postData;\n    // Model.save returns a jqXHR\n    Backbone.Model.prototype.save\n      .call(this.model)\n      .then(function() {\n        self.model.trigger('startSaving');\n        const activationToken = self.model.get('activationToken');\n        const postSubmitData = activationToken ? activationToken : self.model.get('email');\n\n        self.settings.postRegistrationSubmit(\n          postSubmitData,\n          function() {\n            self.doPostSubmit();\n          },\n          function(errors) {\n            self.showErrors(errors);\n          }\n        );\n      })\n      .fail((err) => {\n        const responseJSON = err.responseJSON;\n\n        if (responseJSON && responseJSON.errorCauses.length) {\n          const { errorCode, errorCauses } = responseJSON;\n          const { errorSummary, reason, location } = errorCauses[0];\n\n          const isNotUniqueValue =\n            errorCode === 'E0000001' &&\n            reason === 'UNIQUE_CONSTRAINT';\n\n          if (isNotUniqueValue) {\n            this.renderIsNotUniqueError(responseJSON);\n          }\n\n          this.renderLegacyLocationErrorIfNeeded(location, errorSummary);\n\n          Util.triggerAfterError(\n            this,\n            new RegistrationError(errorSummary)\n          );\n        }\n      });\n  },\n\n  renderIsNotUniqueError: function(error) {\n    const { location } = error.errorCauses[0];\n    const errorSummary = loc(\n      'registration.error.userName.notUniqueWithinOrg',\n      'login',\n      [location]\n    );\n    // replace generic error message with more specific one\n    // without using backbone events because there was a race condition\n    // between clearing and triggering errors\n    this.$el.find('.okta-form-infobox-error p').text(errorSummary);\n  },\n\n  renderLegacyLocationErrorIfNeeded: function(location, errorSummary) {\n    // replace generic error message with errorSummary for v1 SIW\n    // this makes sure that with legacy location that starts with `data.userProfile`\n    // we still see the errorSummary in the error banner instead of only a generic error\n    // See example in https://developer.okta.com/docs/reference/registration-hook/#sample-json-payload-of-request\n    if (location && /^data\\.userProfile.*/.test(location)) {\n      this.$el.find('.okta-form-infobox-error p').text(errorSummary);\n    }\n  },\n\n  createRegistrationModel: function(modelProperties) {\n    const self = this;\n    const RegistrationControllerModel = Model.extend({\n      url: self.getRegistrationApiUrl() + '/register',\n      settings: this.settings,\n      appState: this.options.appState,\n      props: modelProperties,\n      local: {\n        activationToken: 'string',\n      },\n      toJSON: function() {\n        const data = Model.prototype.toJSON.apply(this, arguments);\n\n        return {\n          userProfile: data,\n          relayState: this.settings.get('relayState'),\n        };\n      },\n      parse: function(resp) {\n        this.set('activationToken', resp.activationToken);\n        delete resp.activationToken;\n        return resp;\n      },\n      save: function() {\n        this.settings.preRegistrationSubmit(\n          this.attributes,\n          function(postData) {\n            self.registerUser(postData);\n          },\n          function(errors) {\n            self.showErrors(errors);\n          }\n        );\n      },\n    });\n\n    return new RegistrationControllerModel();\n  },\n  showErrors: function(error, hideRegisterButton) {\n    //for parseSchema error hide form and show error at form level\n    if (error.callback === 'parseRegistrationSchema' && error.errorCauses) {\n      error.errorSummary = _.clone(error.errorCauses[0].errorSummary);\n      delete error.errorCauses;\n    }\n    //show error on form\n    this.model.trigger('error', this.model, {\n      responseJSON: error,\n    });\n\n    //throw registration error\n    const errMsg = error.callback ? error.callback + ':' + error.errorSummary : error.errorSummary;\n\n    Util.triggerAfterError(this, new RegistrationError(errMsg));\n\n    if (hideRegisterButton) {\n      this.$el.find('.button-primary').hide();\n    }\n  },\n  fetchInitialData: function() {\n    const self = this;\n\n    // register parse complete event listener\n    self.state.get('schema').on('parseComplete', function(updatedSchema) {\n      const modelProperties = updatedSchema.properties.createModelProperties();\n\n      self.settings.set('defaultPolicyId', updatedSchema.properties.defaultPolicyId);\n\n      // create model\n      self.model = self.createRegistrationModel(modelProperties);\n      // create form\n      const RegistrationControllerForm = Form.extend({\n        layout: 'o-form-theme',\n        autoSave: true,\n        noCancelButton: true,\n        title: loc('registration.form.title', 'login'),\n        save: loc('registration.form.submit', 'login'),\n        modelEvents : { 'invalid' : 'modifyErrors' },\n        hasSavingState: true,\n        customSavingState: {\n          start: 'startSaving',\n          stop: 'stopSaving',\n        },\n        modifyErrors: function(model, errorResp) {\n          // overwrite courage errorResp object to show custom error message\n          for (let formFieldName in errorResp) {\n            if (errorResp[formFieldName] === 'model.validation.field.string.minLength') {\n              errorResp[formFieldName] = loc('registration.model.validation.field.string.too.short', 'login', \n                [model.props[formFieldName].minLength]\n              );\n            } else if (errorResp[formFieldName] === 'model.validation.field.string.maxLength') {\n              errorResp[formFieldName] = loc('registration.model.validation.field.string.too.long', 'login', \n                [model.props[formFieldName].maxLength + 1]\n              );\n            }\n          }\n        },\n      });\n      const form = new RegistrationControllerForm(self.toJSON());\n\n      // add form\n      self.add(form);\n      // add footer\n      self.footer = new self.Footer(self.toJSON());\n      self.add(self.footer);\n      self.addListeners();\n      if (updatedSchema.error) {\n        self.showErrors(updatedSchema.error, true);\n      } else {\n        // add fields\n        updatedSchema.properties.each(function(schemaProperty) {\n          const inputOptions = RegistrationFormFactory.createInputOptions(schemaProperty);\n          const subSchemas = schemaProperty.get('subSchemas');\n          const name = schemaProperty.get('name');\n\n          form.addInput(inputOptions);\n          if (name === 'password' && subSchemas) {\n            form.add(SubSchema.extend({ id: 'subschemas-' + name, subSchemas: subSchemas }));\n          }\n        });\n        const requiredFieldsLabel = hbs('<span class=\"required-fields-label\">{{label}}</span>')({\n          label: loc('registration.required.fields.label', 'login'),\n        });\n\n        form.add(requiredFieldsLabel);\n      }\n    });\n    // fetch schema from API, returns a jqXHR. Wrap it in a Q\n    return Q(this.state.get('schema').fetch());\n  },\n  Footer: RegistrationControllerFooter,\n});\n"],"names":["RegistrationControllerFooter","View","extend","template","className","events","e","preventDefault","back","state","set","Enums","DIRECTION_BACK","options","appState","trigger","BaseLoginController","initialize","RegistrationControllerSchema","RegistrationSchema","settings","url","get","schema","getRegistrationApiUrl","defaultPolicyId","orgPolicyId","apiUrl","getRegistrationPolicyApi","policyId","doPostSubmit","model","self","callGlobalSuccess","REGISTRATION_COMPLETE","activationToken","loginModel","LoginModel","loginWithActivationToken","then","transaction","registerUser","postData","Object","keys","forEach","k","_","isNull","isUndefined","attributes","Backbone","Model","prototype","save","call","postSubmitData","postRegistrationSubmit","errors","showErrors","fail","err","responseJSON","errorCauses","length","errorCode","errorSummary","reason","location","isNotUniqueValue","renderIsNotUniqueError","renderLegacyLocationErrorIfNeeded","Util","triggerAfterError","RegistrationError","error","loc","$el","find","text","test","createRegistrationModel","modelProperties","RegistrationControllerModel","props","local","toJSON","data","apply","arguments","userProfile","relayState","parse","resp","preRegistrationSubmit","hideRegisterButton","callback","clone","errMsg","hide","fetchInitialData","on","updatedSchema","properties","createModelProperties","RegistrationControllerForm","Form","layout","autoSave","noCancelButton","title","modelEvents","hasSavingState","customSavingState","start","stop","modifyErrors","errorResp","formFieldName","minLength","maxLength","form","add","footer","Footer","addListeners","each","schemaProperty","inputOptions","RegistrationFormFactory","createInputOptions","subSchemas","name","addInput","SubSchema","id","requiredFieldsLabel","label","Q","fetch"],"mappings":"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"}
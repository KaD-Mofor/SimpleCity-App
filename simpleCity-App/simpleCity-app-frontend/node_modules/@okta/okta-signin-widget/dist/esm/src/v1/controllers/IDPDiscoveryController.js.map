{"version":3,"file":"IDPDiscoveryController.js","sources":["../../../../../src/v1/controllers/IDPDiscoveryController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2017, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport PrimaryAuthController from 'v1/controllers/PrimaryAuthController';\nimport IDPDiscoveryModel from 'v1/models/IDPDiscovery';\nimport PrimaryAuthModel from 'v1/models/PrimaryAuth';\nimport BaseLoginController from 'v1/util/BaseLoginController';\nimport IDPDiscoveryForm from 'v1/views/idp-discovery/IDPDiscoveryForm';\nimport CustomButtons from 'v1/views/primary-auth/CustomButtons';\nimport DeviceFingerprint from 'v1/util/DeviceFingerprint';\nimport RouterUtil from 'v1/util/RouterUtil';\nimport Util from 'util/Util';\n\nexport default PrimaryAuthController.extend({\n  className: 'idp-discovery',\n\n  View: IDPDiscoveryForm,\n\n  constructor: function(options) {\n    options.appState.unset('username');\n    let requestContext = options.settings.get('idpDiscovery.requestContext');\n    const lastAuthResponse = options.appState.get('lastAuthResponse');\n    const stateToken = lastAuthResponse && lastAuthResponse?.stateToken;\n\n    //Update requestContext with last stateToken, if the context was stateToken and not a fromUri\n    if(Util.isV1StateToken(requestContext)) {\n      requestContext = stateToken;\n    }\n\n    this.model = new IDPDiscoveryModel(\n      {\n        requestContext: requestContext,\n        settings: options.settings,\n        appState: options.appState,\n      },\n      { parse: true }\n    );\n\n    BaseLoginController.apply(this, arguments);\n\n    this.addListeners();\n\n    // If social auth is configured, 'socialAuthPositionTop' will determine\n    // the order in which the social auth and primary auth are shown on the screen.\n    if (options.settings.get('hasConfiguredButtons')) {\n      this.add(CustomButtons, {\n        prepend: options.settings.get('socialAuthPositionTop'),\n        options: {\n          // To trigger an afterError event, we require the current controller\n          currentController: this,\n        },\n      });\n    }\n\n    this.addFooter(options);\n\n    this.setUsername();\n  },\n\n  initialize: function() {\n    PrimaryAuthController.prototype.initialize.apply(this);\n\n    this.listenTo(this.model, 'goToPrimaryAuth', function() {\n      this.settings.set('username', this.model.get('username'));\n      const self = this;\n      if (this.settings.get('features.deviceFingerprinting')) {\n        DeviceFingerprint.generateDeviceFingerprint(this.settings.get('baseUrl'), this.$el)\n          .then(function(fingerprint) {\n            self.options.appState.set('deviceFingerprint', fingerprint);\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .catch(function() {\n          // Keep going even if device fingerprint fails\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .finally(function() {\n            self.doPrimaryAuth();\n          });\n      } else {\n        self.doPrimaryAuth();\n      }\n    });\n  },\n\n  doPrimaryAuth : function() {\n    if (this.settings.get('features.passwordlessAuth')) {\n      const primaryAuthModel = new PrimaryAuthModel(\n        {\n          username: this.model.get('username'),\n          multiOptionalFactorEnroll: this.options.settings.get('features.multiOptionalFactorEnroll'),\n          settings: this.options.settings,\n          appState: this.options.appState,\n        },\n        { parse: true }\n      );\n\n      // Events to set the transaction attributes on the app state.\n      this.listenTo(primaryAuthModel, 'error', function(src, errObj) {\n        this.toggleButtonState(false);\n        this.model.trigger('error', this.model, errObj);\n      });\n      this.addModelListeners(primaryAuthModel);\n      // Make the primary auth request\n      primaryAuthModel.save();\n    } else {\n      this.options.appState.set('disableUsername', true);\n      const url = RouterUtil.createSigninUrl(\n        this.settings.get('features.prefillUsernameFromIdpDiscovery') && this.model.get('username')\n      );\n      this.options.appState.trigger('navigate', url);\n    }\n  },\n\n});\n"],"names":["PrimaryAuthController","extend","className","View","IDPDiscoveryForm","constructor","options","appState","unset","requestContext","settings","get","lastAuthResponse","stateToken","Util","isV1StateToken","model","IDPDiscoveryModel","parse","BaseLoginController","apply","arguments","addListeners","add","CustomButtons","prepend","currentController","addFooter","setUsername","initialize","prototype","listenTo","set","self","DeviceFingerprint","generateDeviceFingerprint","$el","then","fingerprint","catch","finally","doPrimaryAuth","primaryAuthModel","PrimaryAuthModel","username","multiOptionalFactorEnroll","src","errObj","toggleButtonState","trigger","addModelListeners","save","url","RouterUtil","createSigninUrl"],"mappings":"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"}
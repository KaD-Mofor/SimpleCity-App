{"version":3,"file":"OktaSignIn.js","sources":["../../../../src/widget/OktaSignIn.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { ConfigError } from 'util/Errors';\nimport Util from 'util/Util';\nimport Logger from 'util/Logger';\nimport getAuthClient from 'widget/getAuthClient';\nimport buildRenderOptions from 'widget/buildRenderOptions';\nimport createRouter from 'widget/createRouter';\nimport Hooks from 'models/Hooks';\nimport {\n  WidgetOptions,\n  WidgetOktaAuthConstructor,\n  WidgetOktaAuthInterface,\n  OktaSignInAPI,\n  RenderSuccessCallback,\n  RenderErrorCallback,\n  RenderResult,\n  RenderOptions,\n  HookFunction,\n  RenderResultSuccess,\n  EventCallback,\n  EventCallbackWithError,\n  EventName,\n  RouterClassFactory,\n  AbstractRouter,\n  RouterConstructor,\n  OktaData,\n} from '../types';\nimport { Tokens } from '@okta/okta-auth-js';\n\nconst EVENTS_LIST = ['ready', 'afterError', 'afterRender'];\ndeclare global {\n  interface Window {\n    oktaData?: OktaData;\n  }\n}\n\nexport function createOktaSignIn\n(\n  authClientConstructor: WidgetOktaAuthConstructor,\n  routerClassFactory: RouterClassFactory\n)\n{\n  return class OktaSignIn implements OktaSignInAPI {\n    Router: RouterConstructor;\n    options: WidgetOptions;\n    hooks: Hooks;\n    router: AbstractRouter;\n    authClient: WidgetOktaAuthInterface;\n    // Map original event handler to wrapped one\n    _eventCallbackMap: WeakMap<EventCallback | EventCallbackWithError, EventCallback | EventCallbackWithError>;\n\n    constructor(options: WidgetOptions) {\n      Util.debugMessage(`\n          The Okta Sign-In Widget is running in development mode.\n          When you are ready to publish your app, embed the minified version to turn on production mode.\n          See: https://developer.okta.com/code/javascript/okta_sign-in_widget#cdn\n        `);\n      if (!options.stateToken) {\n        // need to set stateToken here vs in Settings to determine Router.\n        // oktaData is only available to SIW on custom domains.\n        // set stateToken in case user wipes out stateToken when overriding options.\n        options.stateToken = window?.oktaData?.signIn?.stateToken;\n      }\n      this.options = options;\n      this.authClient = getAuthClient(authClientConstructor, options);\n\n      // validate authClient configuration against widget options\n      if (options.useClassicEngine !== true && this.authClient.options.clientId && this.authClient.isPKCE() === false) {\n        throw new ConfigError(\n          'OAuth2 with interaction code flow requires PKCE to be enabled on the authClient.'\n        );\n      }\n\n      // Hooks can be modified before or after render\n      this.hooks = new Hooks({\n        hooks: options.hooks\n      });\n\n      this.Router = routerClassFactory(options);\n\n      this._eventCallbackMap = new WeakMap();\n\n      // Triggers the event up the chain so it is available to the consumers of the widget.\n      this.Router.prototype.Events.listenTo.call(this, this.Router.prototype, 'all', this.trigger);\n\n      // On the first afterRender event (usually when the Widget is ready) - emit a 'ready' event\n      this.once('afterRender', function(context) {\n        this.trigger('ready', context);\n      });\n    }\n\n    /**\n     * Render the sign in widget to an element. Returns a promise that will resolve on success or reject on error.\n     * @param options - options for the signin widget.\n     *        Must have an el or $el property to render the widget to.\n     * @param success - success callback function\n     * @param error - error callback function\n     */\n    renderEl(renderOptions: RenderOptions, successFn?: RenderSuccessCallback, errorFn?: RenderErrorCallback): Promise<RenderResult> {\n      if (this.router) {\n        throw new Error('An instance of the widget has already been rendered. Call remove() first.');\n      }\n\n      const res = createRouter(this.Router, this.options, renderOptions, this.authClient, successFn, errorFn, this.hooks);\n      this.router = res.router;\n      return res.promise;\n    }\n\n    \n    hide(): void {\n      if (this.router) {\n        this.router.hide();\n      }\n    }\n\n    show(): void {\n      if (this.router) {\n        this.router.show();\n      }\n    }\n\n    remove(): void {\n      if (this.router) {\n        this.router.remove();\n        this.router = undefined;\n      }\n    }\n\n    /**\n     * Renders the Widget and returns a promise that resolves to OAuth tokens\n     * @param options - options for the signin widget\n     */\n    showSignInToGetTokens(options?: RenderOptions): Promise<Tokens> {\n      const renderOptions = Object.assign(buildRenderOptions(this.options, options), {\n        redirect: 'never'\n      });\n      const promise = this.renderEl(renderOptions).then(res => {\n        return (res as RenderResultSuccess).tokens;\n      });\n      const authClient = this.router.settings.getAuthClient();\n      if (authClient.isAuthorizationCodeFlow() && !authClient.isPKCE()) {\n        throw new ConfigError('\"showSignInToGetTokens()\" should not be used for authorization_code flow. ' + \n          'Use \"showSignInAndRedirect()\" instead');\n      }\n      return promise;\n    }\n\n    /**\n     * Renders the widget and redirects to the OAuth callback\n     * @param options - options for the signin widget\n     */\n    showSignInAndRedirect(options?: RenderOptions): Promise<void> {\n      const renderOptions = Object.assign(buildRenderOptions(this.options, options), {\n        redirect: 'always'\n      });\n      return this.renderEl(renderOptions).then(() => {\n        // This method should never return, it will either redirect or reject with error\n        return;\n      });\n    }\n\n    /**\n     * Renders the widget. Either resolves the returned promise, or redirects.\n     * @param options - options for the signin widget\n     */\n    showSignIn(options?: RenderOptions): Promise<RenderResult> {\n      const renderOptions = Object.assign(buildRenderOptions(this.options, options));\n      return this.renderEl(renderOptions);\n    }\n\n    // Hook convenience functions\n    before(formName: string, callbackFn: HookFunction): void {\n      this.hooks.mergeHook(formName, {\n        before: [\n          callbackFn\n        ]\n      });\n    }\n\n    after(formName: string, callbackFn: HookFunction): void {\n      this.hooks.mergeHook(formName, {\n        after: [\n          callbackFn\n        ]\n      });\n    }\n\n    getUser(): any {\n      return this.router?.appState?.getUser();\n    }\n    \n    // Events API\n\n    on(event: EventName, callback: EventCallback | EventCallbackWithError): void {\n      // custom events listener on widget instance to trap third-party callback errors\n      if (EVENTS_LIST.includes(event)) {\n        const origCallback = callback;\n        callback = function(...callbackArgs) {\n          try {\n            origCallback.apply(this, callbackArgs);\n          } catch (err) {\n            Logger.error(`[okta-signin-widget] \"${event}\" event handler error:`, err);\n          }\n        };\n        this._eventCallbackMap.set(origCallback, callback);\n      }\n      this.Router.prototype.Events.on.call(this, event, callback);\n    }\n\n    off(event?: EventName, callback?: EventCallback | EventCallbackWithError): void {\n      if (callback) {\n        callback = this._eventCallbackMap.get(callback) || callback;\n      }\n      this.Router.prototype.Events.off.call(this, event, callback);\n    }\n\n    once(event: EventName, callback: EventCallback): void {\n      this.Router.prototype.Events.once.call(this, event, callback);\n    }\n\n    stopListening(event?: EventName, callback?: EventCallback): void {\n      this.Router.prototype.Events.stopListening.call(this, event, callback);\n    }\n\n    listenTo(object: any, event: EventName, callback: EventCallback): void {\n      this.Router.prototype.Events.listenTo.call(this, object, event, callback);\n    }\n\n    trigger(event: EventName, ...args: any[]): void {\n      this.Router.prototype.Events.trigger.apply(this, [event, ...args]);\n    }\n\n  };\n}\n"],"names":["EVENTS_LIST","createOktaSignIn","authClientConstructor","routerClassFactory","OktaSignIn","constructor","options","Router","hooks","router","authClient","_eventCallbackMap","Util","debugMessage","stateToken","window","oktaData","signIn","getAuthClient","useClassicEngine","clientId","isPKCE","ConfigError","Hooks","WeakMap","prototype","Events","listenTo","call","trigger","once","context","renderEl","renderOptions","successFn","errorFn","Error","res","createRouter","promise","hide","show","remove","undefined","showSignInToGetTokens","Object","assign","buildRenderOptions","redirect","then","tokens","settings","isAuthorizationCodeFlow","showSignInAndRedirect","showSignIn","before","formName","callbackFn","mergeHook","after","getUser","appState","on","event","callback","includes","origCallback","callbackArgs","apply","err","Logger","error","set","off","get","stopListening","object","args"],"mappings":"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"}
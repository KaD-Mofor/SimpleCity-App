{"version":3,"file":"SecurityBeacon.js","sources":["../../../../../../src/v1/views/shared/SecurityBeacon.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, $, loc, View } from '@okta/courage';\nimport hbs from '@okta/handlebars-inline-precompile';\nimport Animations from 'util/Animations';\n\nfunction setBackgroundImage(el, appState) {\n  const imgSrc = appState.get('securityImage');\n  const imgDescription = appState.get('securityImageDescription');\n  const isUndefinedUser = appState.get('isUndefinedUser');\n  const isNewUser = appState.get('isNewUser');\n  const isSecurityImage = !isUndefinedUser && !isNewUser;\n  // NOTE: The imgSrc is returned by the server so that every\n  // user has a unique image. However new and undefined user states\n  // are hard coded into the css and the value returned by the server\n  // is ignored.\n\n  el.css('background-image', '');\n  el.removeClass('new-user undefined-user');\n  if (isNewUser) {\n    el.addClass('new-user');\n    return;\n  }\n  if (isUndefinedUser) {\n    el.addClass('undefined-user');\n    return;\n  }\n  if (isSecurityImage) {\n    // TODO: Newer versions of qtip will remove aria-describedby on their own when destroy() is called.\n    el.removeAttr('aria-describedby');\n    el.find('.accessibility-text').text(imgDescription);\n    el.css('background-image', 'url(' + _.escape(imgSrc) + ')');\n    return;\n  }\n}\n\nfunction antiPhishingMessage(image, host) {\n  $(window).on(\n    'resize.securityBeaconQtip',\n    _.debounce(function() {\n      if (image.is(':visible')) {\n        image.qtip('show');\n      }\n    }, 300)\n  );\n\n  // Show the message that the user has not logged in from this device before.\n  image.qtip({\n    prerender: true,\n    content: {\n      text: loc('primaryauth.newUser.tooltip', 'login', [_.escape(host)]),\n      button: loc('primaryauth.newUser.tooltip.close', 'login'),\n    },\n    style: {\n      classes: 'okta-security-image-tooltip security-image-qtip qtip-custom qtip-shadow qtip-rounded',\n      tip: { height: 12, width: 16 },\n    },\n    position: {\n      my: 'top center',\n      at: 'center',\n      target: $('.auth-beacon-security'),\n      adjust: { method: 'flip', scroll: false, resize: true },\n      effect: false,\n    },\n    hide: { event: false, fixed: true },\n    show: { event: false, delay: 200 },\n    events: {\n      move: function(event, api) {\n        if (!api.elements.target.is(':visible')) {\n          // Have to hide it immediately, with no effect\n          api.set('hide.effect', false);\n          api.hide();\n          api.set('hide.effect', true);\n        }\n      },\n    },\n  });\n\n  // It is necessary to delay toggle to the next render cycle, since qtip internally defers some setup tasks.\n  setTimeout(() => {\n    image.qtip('toggle', image.is(':visible'));\n  }, 0);\n}\n\nfunction destroyAntiPhishingMessage(image) {\n  image.qtip('destroy');\n  $(window).off('resize.securityBeaconQtip');\n}\n\nasync function updateSecurityImage($el, appState, animate) {\n  const image = $el.find('.auth-beacon-security');\n  const border = $el.find('.js-auth-beacon-border');\n  const hasBorder = !appState.get('isUndefinedUser');\n  const hasAntiPhishing = appState.get('isNewUser');\n  const radialProgressBar = $el.find('.radial-progress-bar');\n  const host = appState.get('baseUrl').match(/https?:\\/\\/(.[^/]+)/)[1];\n  const duration = 200;\n\n  if (!animate) {\n    // Do not animate the security beacon\n    // This occurs when initializing the form\n    setBackgroundImage(image, appState);\n    border.toggleClass('auth-beacon-border', hasBorder);\n    return;\n  }\n\n  destroyAntiPhishingMessage(image);\n\n  // Animate loading the security beacon\n  if (!hasBorder) {\n    // This occurs when appState username is blank\n    // we do not yet know if the user is recognized\n    image.fadeOut(duration, function() {\n      setBackgroundImage(image, appState);\n      border.removeClass('auth-beacon-border');\n      image.fadeIn(duration);\n    });\n  } else {\n    // Animate loading the security beacon with a loading bar for the border\n    // This occurs when the username has been checked against Okta.\n    border.removeClass('auth-beacon-border');\n    await Animations.radialProgressBar({\n      $el: radialProgressBar,\n      swap() {\n        image.fadeOut(duration, () => {\n          setBackgroundImage(image, appState);\n          image.fadeIn(duration);\n        });\n      },\n    });\n    border.addClass('auth-beacon-border');\n    if (hasAntiPhishing) {\n      antiPhishingMessage(image, host);\n    }\n  }\n}\n\nexport default View.extend({\n  template: hbs(\n    '\\\n    <div class=\"beacon-blank\">\\\n      <div class=\"radial-progress-bar\">\\\n        <div class=\"circle left\"></div>\\\n        <div class=\"circle right\"></div>\\\n      </div>\\\n    </div>\\\n    <div aria-live=\"polite\" role=\"img\" class=\"bg-helper auth-beacon auth-beacon-security\" data-se=\"security-beacon\">\\\n      <span class=\"accessibility-text\"></span>\\\n      <div class=\"okta-sign-in-beacon-border auth-beacon-border js-auth-beacon-border\">\\\n      </div>\\\n    </div>\\\n    '\n  ),\n  className: 'js-security-beacon',\n\n  initialize: function(options) {\n    this.update = _.partial(updateSecurityImage, this.$el, options.appState);\n    this.listenTo(options.appState, 'change:securityImage', this.update);\n    this.listenTo(options.appState, 'loading', function(isLoading) {\n      this.$el.toggleClass('beacon-loading', isLoading);\n      this.removeAntiPhishingMessage();\n    });\n    this.options.appState.set('beaconType', 'security');\n\n    this.listenTo(options.appState, 'navigate', this.removeAntiPhishingMessage);\n  },\n\n  postRender: function() {\n    this.update(false);\n  },\n\n  equals: function(Beacon) {\n    return Beacon && this instanceof Beacon;\n  },\n\n  removeAntiPhishingMessage: function() {\n    const image = this.$el.find('.auth-beacon-security');\n\n    image.qtip('destroy');\n  },\n});\n"],"names":["setBackgroundImage","el","appState","imgSrc","get","imgDescription","isUndefinedUser","isNewUser","isSecurityImage","css","removeClass","addClass","removeAttr","find","text","_","escape","antiPhishingMessage","image","host","$","window","on","debounce","is","qtip","prerender","content","loc","button","style","classes","tip","height","width","position","my","at","target","adjust","method","scroll","resize","effect","hide","event","fixed","show","delay","events","move","api","elements","set","setTimeout","destroyAntiPhishingMessage","off","updateSecurityImage","$el","animate","border","hasBorder","hasAntiPhishing","radialProgressBar","match","duration","toggleClass","fadeOut","fadeIn","Animations","swap","View","extend","template","className","initialize","options","update","partial","listenTo","isLoading","removeAntiPhishingMessage","postRender","equals","Beacon"],"mappings":"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"}
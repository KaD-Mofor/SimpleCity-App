{"version":3,"file":"PrimaryAuthController.js","sources":["../../../../../src/v1/controllers/PrimaryAuthController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { $ } from '@okta/courage';\nimport PrimaryAuthModel from 'v1/models/PrimaryAuth';\nimport BaseLoginController from 'v1/util/BaseLoginController';\nimport DeviceFingerprint from 'v1/util/DeviceFingerprint';\nimport CustomButtons from 'v1/views/primary-auth/CustomButtons';\nimport PrimaryAuthForm from 'v1/views/primary-auth/PrimaryAuthForm';\nimport Footer from 'v1/views/shared/Footer';\nimport FooterRegistration from 'v1/views/shared/FooterRegistration';\nimport FooterWithBackLink from 'v1/views/shared/FooterWithBackLink';\nexport default BaseLoginController.extend({\n  className: 'primary-auth',\n\n  state: { enabled: true },\n\n  View: PrimaryAuthForm,\n\n  constructor: function(options) {\n    options.appState.unset('username');\n\n    this.model = new PrimaryAuthModel(\n      {\n        multiOptionalFactorEnroll: options.settings.get('features.multiOptionalFactorEnroll'),\n        settings: options.settings,\n        appState: options.appState,\n      },\n      { parse: true }\n    );\n\n    BaseLoginController.apply(this, arguments);\n\n    this.addListeners();\n\n    // If social auth is configured, 'socialAuthPositionTop' will determine\n    // the order in which the social auth and primary auth are shown on the screen.\n    if (options.settings.get('hasConfiguredButtons')) {\n      this.add(CustomButtons, {\n        prepend: options.settings.get('socialAuthPositionTop'),\n        options: {\n          // To trigger an afterError event, we require the current controller\n          currentController: this,\n        },\n      });\n    }\n\n    this.addFooter(options);\n    if (this.options.appState.get('disableUsername')) {\n      this.addFooterWithBackLink(this.options);\n    }\n\n    this.setUsername();\n  },\n\n  addFooter: function(options) {\n    this.add(new Footer(this.toJSON({ appState: options.appState })));\n\n    if (options.settings.get('features.registration') || options.appState.get('isIdxStateToken')) {\n      this.add(\n        new FooterRegistration({\n          settings: this.settings,\n          appState: options.appState,\n        })\n      );\n    }\n  },\n\n  addFooterWithBackLink: function(options) {\n    if (!this.$el.find('.footer-back-link').length) {\n      this.add(new FooterWithBackLink(this.toJSON({ \n        appState: options.appState,\n        className: 'auth-footer footer-back-link',\n      })));\n    }\n  },\n\n  setUsername: function() {\n    const username = this.model.get('username');\n\n    if (username) {\n      this.options.appState.set('username', username);\n    }\n  },\n\n  setUsernameFromIdpDiscovery: function() {\n    const username = this.options.username;\n    if (username) {\n      this.model.set('username', username);\n      this.options.appState.set('disableUsername', true);\n    }\n  },\n\n  events: {\n    'focusout input[name=username]': function() {\n      if (this.shouldComputeDeviceFingerprint() && this.model.get('username')) {\n        const self = this;\n\n        this.options.appState.trigger('loading', true);\n        DeviceFingerprint.generateDeviceFingerprint(this.settings.get('baseUrl'), this.$el)\n          .then(function(fingerprint) {\n            self.options.appState.set('deviceFingerprint', fingerprint);\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .catch(function() {\n            // Keep going even if device fingerprint fails\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .finally(function() {\n            self.options.appState.trigger('loading', false);\n          });\n      } else {\n        this.options.appState.set('username', this.model.get('username'));\n      }\n    },\n    'focusin input': function(e) {\n      $(e.target.parentElement).addClass('focused-input');\n    },\n    'focusout input': function(e) {\n      $(e.target.parentElement).removeClass('focused-input');\n    },\n  },\n\n  // This model and the AppState both have a username property.\n  // The controller updates the AppState's username when the user is\n  // done editing (on blur) or deletes the username (see below).\n  initialize: function() {\n    this.options.appState.unset('deviceFingerprint');\n    if (this.settings.get('features.prefillUsernameFromIdpDiscovery')) {\n      this.setUsernameFromIdpDiscovery();\n    }\n    this.listenTo(this.model, 'change:username', function(model, value) {\n      if (!value) {\n        // reset AppState to an undefined user.\n        this.options.appState.set('username', '');\n      }\n    });\n    this.listenTo(this.model, 'save', function() {\n      this.state.set('enabled', false);\n    });\n    this.listenTo(this.model, 'error', function() {\n      this.state.set('enabled', true);\n      if (this.options.appState.get('disableUsername')) {\n        this.state.set('disableUsername', true);\n        this.addFooterWithBackLink(this.options);\n      }\n    });\n    this.listenTo(this.state, 'togglePrimaryAuthButton', function(buttonState) {\n      this.toggleButtonState(buttonState);\n    });\n  },\n\n  shouldComputeDeviceFingerprint: function() {\n    return (\n      this.settings.get('features.securityImage') &&\n      this.settings.get('features.deviceFingerprinting') &&\n      this.settings.get('features.useDeviceFingerprintForSecurityImage')\n    );\n  },\n});\n"],"names":["BaseLoginController","extend","className","state","enabled","View","PrimaryAuthForm","constructor","options","appState","unset","model","PrimaryAuthModel","multiOptionalFactorEnroll","settings","get","parse","apply","arguments","addListeners","add","CustomButtons","prepend","currentController","addFooter","addFooterWithBackLink","setUsername","Footer","toJSON","FooterRegistration","$el","find","length","FooterWithBackLink","username","set","setUsernameFromIdpDiscovery","events","shouldComputeDeviceFingerprint","self","trigger","DeviceFingerprint","generateDeviceFingerprint","then","fingerprint","catch","finally","e","$","target","parentElement","addClass","removeClass","initialize","listenTo","value","buttonState","toggleButtonState"],"mappings":"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"}
{"version":3,"file":"VerifyDuoController.js","sources":["../../../../../src/v1/controllers/VerifyDuoController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint camelcase: 0 */\nimport { $, _, loc } from '@okta/courage';\nimport Duo from '@okta/duo';\nimport Q from 'q';\nimport FactorUtil from 'util/FactorUtil';\nimport FormController from 'v1/util/FormController';\nimport FooterMFA from 'v1/views/shared/FooterMFA';\n\nexport default FormController.extend({\n  className: 'mfa-verify-duo duo-form',\n\n  Model: {\n    props: {\n      host: 'string',\n      signature: 'string',\n      postAction: 'string',\n      factorId: 'string',\n      stateToken: 'string',\n      rememberDevice: 'boolean',\n    },\n\n    initialize: function() {\n      const rememberDevice = FactorUtil.getRememberDeviceValue(this.appState);\n\n      // set the initial value for remember device (Cannot do this while defining the\n      // local property because this.settings would not be initialized there yet).\n      this.set('rememberDevice', rememberDevice);\n    },\n\n    getInitOptions: function() {\n      const rememberDevice = !!this.get('rememberDevice');\n\n      return this.doTransaction(function(transaction) {\n        const data = {\n          rememberDevice: rememberDevice,\n        };\n\n        const factor = _.findWhere(transaction.factors, {\n          provider: 'DUO',\n          factorType: 'web',\n        });\n\n        return factor.verify(data).catch(function(err) {\n          // Clean up the cookie on failure.\n          throw err;\n        });\n      }, true /* rethrow errors */);\n    },\n\n    verify: function(signedResponse) {\n      const url = this.get('postAction');\n      const factorId = this.get('factorId');\n      const self = this;\n      let data = {\n        id: factorId,\n        stateToken: this.get('stateToken'),\n        sig_response: signedResponse,\n      };\n      // Note: We should be doing this in OktaAuth! Fix when it's updated.\n\n      const rememberDevice = this.get('rememberDevice');\n      // We don't actually use authClient.post() here (unlike all the other cases in the\n      // sign-in widget) since the endpoint is wired to accept serialized form post instead\n      // of a JSON post ($.post() is different from authClient.post() in that in $.post(),\n      // jquery decides the Content-Type instead of it being a JSON type). Enroll/Verify DUO\n      // are the only two places where we actually do this.\n      // NOTE - If we ever decide to change this, we should test this very carefully.\n\n      return Q($.post(url, data))\n        .then(function() {\n          return self.doTransaction(function(transaction) {\n            let data;\n\n            if (rememberDevice) {\n              data = { rememberDevice: rememberDevice };\n            }\n            return transaction.poll(data);\n          });\n        })\n        .catch(function(err) {\n          self.trigger('error', self, err.xhr);\n        });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    noButtonBar: true,\n    title: _.partial(loc, 'factor.duo'),\n    attributes: { 'data-se': 'factor-duo' },\n\n    postRender: function() {\n      this.add('<iframe frameborder=\"0\" title=\"' + this.title() + '\"></iframe>');\n      if (this.options.appState.get('allowRememberDevice')) {\n        this.addInput({\n          label: false,\n          'label-top': true,\n          placeholder: this.options.appState.get('rememberDeviceLabel'),\n          className: 'margin-btm-0',\n          name: 'rememberDevice',\n          type: 'checkbox',\n        });\n      }\n      Duo.init({\n        host: this.model.get('host'),\n        sig_request: this.model.get('signature'),\n        iframe: this.$('iframe').get(0),\n        post_action: _.bind(this.model.verify, this.model),\n      });\n    },\n  },\n\n  fetchInitialData: function() {\n    const self = this;\n\n    return this.model.getInitOptions().then(function(trans) {\n      const res = trans.data;\n\n      if (\n        !res._embedded ||\n        !res._embedded.factor ||\n        !res._embedded.factor._embedded ||\n        !res._embedded.factor._embedded.verification\n      ) {\n        throw new Error('Response does not have duo verification options');\n      }\n      const verification = res._embedded.factor._embedded.verification;\n\n      self.model.set({\n        host: verification.host,\n        signature: verification.signature,\n        postAction: verification._links.complete.href,\n        factorId: res._embedded.factor.id,\n        stateToken: res.stateToken,\n      });\n    });\n  },\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaChallenge')) {\n      return true;\n    }\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  Footer: FooterMFA,\n});\n"],"names":["FormController","extend","className","Model","props","host","signature","postAction","factorId","stateToken","rememberDevice","initialize","FactorUtil","getRememberDeviceValue","appState","set","getInitOptions","get","doTransaction","transaction","data","factor","_","findWhere","factors","provider","factorType","verify","catch","err","signedResponse","url","self","id","sig_response","Q","$","post","then","poll","trigger","xhr","Form","autoSave","noButtonBar","title","partial","loc","attributes","postRender","add","options","addInput","label","placeholder","name","type","Duo","init","model","sig_request","iframe","post_action","bind","fetchInitialData","trans","res","_embedded","verification","Error","_links","complete","href","trapAuthResponse","back","Footer","FooterMFA"],"mappings":"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"}
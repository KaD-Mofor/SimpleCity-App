{"version":3,"file":"DeviceChallengePollView.js","sources":["../../../../../../../src/v2/view-builder/views/device/DeviceChallengePollView.js"],"sourcesContent":["import { loc, createCallout } from '@okta/courage';\nimport { BaseFooter, BaseView, BaseOktaVerifyChallengeView } from '../../internals';\nimport Enums from '../../../../util/Enums';\nimport {\n  CANCEL_POLLING_ACTION,\n  IDENTIFIER_FLOW,\n  AUTHENTICATION_CANCEL_REASONS,\n} from '../../utils/Constants';\nimport Link from '../../components/Link';\nimport { doChallenge, cancelPollingWithParams } from '../../utils/ChallengeViewUtil';\nimport OktaVerifyAuthenticatorHeader from '../../components/OktaVerifyAuthenticatorHeader';\nimport { getSignOutLink } from '../../utils/LinksUtil';\nimport CustomAccessDeniedErrorMessage from '../shared/CustomAccessDeniedErrorMessage';\n\nconst CUSTOM_ACCESS_DENIED_KEY = 'security.access_denied_custom_message';\n\nconst Body = BaseOktaVerifyChallengeView.extend({\n  pollingCancelAction: CANCEL_POLLING_ACTION,\n\n  getDeviceChallengePayload() {\n    return this.options.currentViewState.relatesTo.value;\n  },\n\n  doChallenge() {\n    doChallenge(this, IDENTIFIER_FLOW);\n  },\n\n  onPollingFail() {\n    BaseOktaVerifyChallengeView.prototype.onPollingFail.apply(this, arguments);\n    // When SIW receives form error, polling is already stopped\n    // SIW needs to update footer link from /poll/cancel to /idp/idx/cancel\n    const data = { label: loc('loopback.polling.cancel.link.with.form.error', 'login') };\n    this.options.appState.trigger('updateFooterLink', data);\n  },\n\n  showCustomFormErrorCallout(error, messages) {\n    const responseJSON = error.responseJSON;\n    let options = {\n      type: 'error',\n      className: 'okta-verify-uv-callout-content',\n      subtitle: responseJSON.errorSummary,\n    };\n\n    const containsSignedNonceError = responseJSON.errorSummaryKeys &&\n      responseJSON.errorSummaryKeys.some((key) => key.includes('auth.factor.signedNonce.error'));\n    if (containsSignedNonceError) {\n      options.title = loc('user.fail.verifyIdentity', 'login');\n    }\n\n    const containsCustomAccessDeniedError = responseJSON.errorSummaryKeys &&\n      responseJSON.errorSummaryKeys.some((key) => key.includes('security.access_denied_custom_message'));\n    if(containsCustomAccessDeniedError) {\n      const message = messages?.find(message => message.i18n.key === CUSTOM_ACCESS_DENIED_KEY);\n      if (!message) {\n        return false;\n      }\n      options = {\n        type: 'error',\n        content: new CustomAccessDeniedErrorMessage({\n          message: responseJSON.errorSummary,\n          links: message.links,\n        })\n      };\n    }\n\n    this.showMessages(createCallout(options));\n    return true;\n  },\n});\n\nconst Footer = BaseFooter.extend({\n  initialize() {\n    this.listenTo(this.options.appState, 'updateFooterLink', this.handleUpdateFooterLink);\n    if (this.isFallbackApproach() && !this.isFallbackDelayed()) {\n      BaseFooter.prototype.initialize.apply(this, arguments);\n    } else {\n      this.backLink = this.add(Link, {\n        options: {\n          name: 'cancel-authenticator-challenge',\n          label: loc('loopback.polling.cancel.link', 'login'),\n          clickHandler: () => {\n            cancelPollingWithParams(\n              this.options.appState,\n              CANCEL_POLLING_ACTION,\n              AUTHENTICATION_CANCEL_REASONS.USER_CANCELED,\n              null\n            );\n          },\n        }\n      }).last();\n    }\n  },\n\n  handleUpdateFooterLink(data) {\n    // only update link for loopback\n    if (!this.isFallbackApproach() || this.isFallbackDelayed()) {\n      this.backLink && this.backLink.remove();\n      this.backLink = this.add(Link, {\n        options: getSignOutLink(this.options.settings, data)[0]\n      }).last();\n    } \n  },\n\n  isFallbackApproach() {\n    return [\n      Enums.CUSTOM_URI_CHALLENGE,\n      Enums.UNIVERSAL_LINK_CHALLENGE,\n      Enums.APP_LINK_CHALLENGE\n    ].includes(this.options.currentViewState.relatesTo.value.challengeMethod);\n  },\n\n  isFallbackDelayed() {\n    // only delay showing the reopen Okta Verify button for the app link approach for now\n    // until we have more data shows other approaches have the slow cold start problem of the Okta Verify app as well\n    return this.options.currentViewState.relatesTo.value.challengeMethod === Enums.APP_LINK_CHALLENGE;\n  },\n});\n\nexport default BaseView.extend({\n  Header: OktaVerifyAuthenticatorHeader,\n  Body,\n  Footer\n});\n"],"names":["CUSTOM_ACCESS_DENIED_KEY","Body","BaseOktaVerifyChallengeView","extend","pollingCancelAction","CANCEL_POLLING_ACTION","getDeviceChallengePayload","options","currentViewState","relatesTo","value","doChallenge","IDENTIFIER_FLOW","onPollingFail","prototype","apply","arguments","data","label","loc","appState","trigger","showCustomFormErrorCallout","error","messages","responseJSON","type","className","subtitle","errorSummary","containsSignedNonceError","errorSummaryKeys","some","key","includes","title","containsCustomAccessDeniedError","message","find","i18n","content","CustomAccessDeniedErrorMessage","links","showMessages","createCallout","Footer","BaseFooter","initialize","listenTo","handleUpdateFooterLink","isFallbackApproach","isFallbackDelayed","backLink","add","Link","name","clickHandler","cancelPollingWithParams","AUTHENTICATION_CANCEL_REASONS","USER_CANCELED","last","remove","getSignOutLink","settings","Enums","CUSTOM_URI_CHALLENGE","UNIVERSAL_LINK_CHALLENGE","APP_LINK_CHALLENGE","challengeMethod","BaseView","Header","OktaVerifyAuthenticatorHeader"],"mappings":"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"}
{"version":3,"file":"Factor.js","sources":["../../../../../src/v1/models/Factor.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n/* eslint complexity: [2, 13] */\nimport { _, loc, Collection } from '@okta/courage';\nimport Q from 'q';\nimport { AuthStopPollInitiationError } from 'util/Errors';\nimport factorUtil from 'util/FactorUtil';\nimport Util from 'util/Util';\nimport BaseLoginModel from './BaseLoginModel';\nconst PUSH_INTERVAL = 4000;\n\n// Avoid setting interval to same value as keep-alive time (5 seconds) because it\n// caused an occasional issue with network connection lost errors in Safari and IE\n\nconst FactorFactor = BaseLoginModel.extend({\n  extraProperties: true,\n  flat: false,\n\n  props: {\n    id: 'string',\n    factorType: {\n      type: 'string',\n      values: [\n        'sms',\n        'call',\n        'email',\n        'token',\n        'token:software:totp',\n        'token:hotp',\n        'token:hardware',\n        'question',\n        'push',\n        'u2f',\n        'password',\n        'assertion:saml2',\n        'assertion:oidc',\n        'claims_provider',\n        'webauthn',\n      ],\n    },\n    provider: {\n      type: 'string',\n      values: [\n        'OKTA',\n        'RSA',\n        'DEL_OATH',\n        'SYMANTEC',\n        'GOOGLE',\n        'YUBICO',\n        'FIDO',\n        'CUSTOM',\n        'GENERIC_SAML',\n        'GENERIC_OIDC',\n      ],\n    },\n    enrollment: {\n      type: 'string',\n      values: ['OPTIONAL', 'REQUIRED'],\n    },\n    status: {\n      type: 'string',\n      values: ['NOT_SETUP', 'ACTIVE'],\n    },\n    profile: ['object'],\n    vendorName: 'string',\n    policy: ['object'],\n    profiles: ['object'],\n  },\n\n  local: {\n    answer: 'string',\n    password: 'string',\n    backupFactor: 'object',\n    showAnswer: 'boolean',\n    rememberDevice: 'boolean',\n    autoPush: ['boolean', true, false],\n  },\n\n  derived: {\n    isOktaFactor: {\n      deps: ['provider'],\n      fn: function(provider) {\n        return provider === 'OKTA';\n      },\n    },\n    factorName: {\n      deps: ['provider', 'factorType'],\n      fn: factorUtil.getFactorName,\n    },\n    factorLabel: {\n      deps: ['provider', 'factorType', 'vendorName'],\n      fn: function(provider, factorType, vendorName) {\n        if (_.contains(['DEL_OATH', 'GENERIC_SAML', 'GENERIC_OIDC', 'CUSTOM'], provider)) {\n          return vendorName;\n        }\n        return factorUtil.getFactorLabel.apply(this, [provider, factorType]);\n      },\n    },\n    factorDescription: {\n      deps: ['provider', 'factorType'],\n      fn: factorUtil.getFactorDescription,\n    },\n    sortOrder: {\n      deps: ['provider', 'factorType'],\n      fn: factorUtil.getFactorSortOrder,\n    },\n    iconClassName: {\n      deps: ['provider', 'factorType'],\n      fn: factorUtil.getFactorIconClassName,\n    },\n    securityQuestion: {\n      deps: ['profile', 'factorType'],\n      fn: function(profile, factorType) {\n        if (factorType !== 'question') {\n          return null;\n        }\n        return profile && factorUtil.getSecurityQuestionLabel(profile);\n      },\n    },\n    phoneNumber: {\n      deps: ['profile', 'factorType'],\n      fn: function(profile, factorType) {\n        if (_.contains(['sms', 'call'], factorType)) {\n          return profile && profile.phoneNumber;\n        }\n        return null;\n      },\n    },\n    email: {\n      deps: ['profile', 'factorType'],\n      fn: function(profile, factorType) {\n        if (factorType === 'email') {\n          return profile && profile.email;\n        }\n        return null;\n      },\n    },\n    deviceName: {\n      deps: ['profile', 'factorType'],\n      fn: function(profile, factorType) {\n        if (factorType !== 'push') {\n          return null;\n        }\n        return profile && profile.name;\n      },\n    },\n    enrolled: {\n      deps: ['status'],\n      fn: function(status) {\n        return status === 'ACTIVE';\n      },\n    },\n    cardinality: {\n      deps: ['policy', 'profiles'],\n      fn: function(policy, profiles) {\n        if (profiles && profiles.length > 0) {\n          const profile = profiles[0];\n          //assume for now we only get one profile (multiple profiles are not supported yet)\n\n          const enrolled = profile._embedded.enrolledFactors.length;\n\n          const adoption = _.findWhere(profile._embedded.features, { type: 'adoption' });\n\n          if (adoption && adoption.cardinality) {\n            return {\n              enrolled: enrolled,\n              minimum: adoption.cardinality.min,\n              maximum: adoption.cardinality.max,\n            };\n          }\n          return false;\n        } else if (policy && policy.enrollment) {\n          return policy.enrollment;\n        } else {\n          return false;\n        }\n      },\n    },\n    additionalEnrollment: {\n      deps: ['cardinality'],\n      fn: function(cardinality) {\n        if (cardinality) {\n          return cardinality.enrolled !== 0 && cardinality.enrolled < cardinality.maximum;\n        } else {\n          return false;\n        }\n      },\n    },\n    required: {\n      deps: ['enrollment'],\n      fn: function(enrollment) {\n        return enrollment === 'REQUIRED';\n      },\n    },\n    canUseResend: {\n      deps: ['provider', 'factorType'],\n      fn: function(provider, factorType) {\n        // Only push, sms and call have resend links.\n        return provider === 'OKTA' && _.contains(['push', 'sms', 'call', 'email'], factorType);\n      },\n    },\n    isAnswerRequired: {\n      deps: ['factorType'],\n      fn: function(factorType) {\n        return _.contains(['sms', 'call', 'email', 'token', 'token:software:totp', 'question'], factorType);\n      },\n    },\n    isFactorTypeVerification: {\n      deps: ['provider', 'id'],\n      fn: function(provider, id) {\n        return provider === undefined && id === undefined;\n      },\n    },\n  },\n\n  parse: function(attributes) {\n    this.settings = attributes.settings;\n    this.appState = attributes.appState;\n    // set the initial value for remember device.\n    attributes.rememberDevice = factorUtil.getRememberDeviceValue(this.appState);\n\n    // Add vendorname for custom totp enroll\n    this.setCustomHotpVendorName(attributes);\n    return _.omit(attributes, ['settings', 'appState']);\n  },\n\n  validate: function() {\n    if (this.get('isAnswerRequired') && !this.get('answer')) {\n      return { answer: loc('model.validation.field.blank') };\n    } else if (this.get('factorType') === 'password' && !this.get('password')) {\n      return { password: loc('error.password.required') };\n    }\n  },\n  needsPasscode: function() {\n    // we don't need passcode for email with magic link flow\n    return !(this.options.appState.get('isIdxStateToken') && this.get('factorType') === 'email');\n  },\n  resend: function() {\n    this.trigger('form:clear-errors');\n    return this.manageTransaction(function(transaction) {\n      const firstLink = transaction.data._links.resend[0];\n\n      return transaction.resend(firstLink.name);\n    });\n  },\n\n  save: function() {\n    const rememberDevice = !!this.get('rememberDevice');\n    const self = this;\n    // Set/Remove the remember device cookie based on the remember device input.\n\n    return this.manageTransaction(function(transaction, setTransaction) {\n      const data = {\n        rememberDevice: rememberDevice,\n      };\n\n      if (this.get('factorType') === 'question') {\n        data.answer = this.get('answer');\n      } else if (this.get('factorType') === 'password') {\n        data.password = this.get('password');\n      } else if (this.needsPasscode()) {\n        data.passCode = this.get('answer');\n      }\n\n      if (this.pushFactorHasAutoPush()) {\n        data.autoPush = this.get('autoPush');\n      }\n\n      let promise;\n\n      // MFA_REQUIRED, FACTOR_REQUIRED or UNAUTHENTICATED with factors (passwordlessAuth)\n      if (\n        transaction.status === 'MFA_REQUIRED' ||\n        transaction.status === 'FACTOR_REQUIRED' ||\n        this.appState.get('promptForFactorInUnauthenticated')\n      ) {\n        const factor = this._findFactor(transaction);\n\n        promise = factor.verify(data);\n      } else if (this.get('canUseResend') && !this.get('answer') && transaction.resend) {\n        // MFA_CHALLENGE/ FACTOR_CHALLENGE\n        const firstLink = transaction.data._links.resend[0];\n\n        promise = transaction.resend(firstLink.name);\n      } else {\n        promise = transaction.verify(data);\n      }\n      //the 'save' event here is triggered and used in the BaseLoginController\n      //to disable the primary button on the factor form\n      this.trigger('save');\n\n      return promise.then(function(trans) {\n        const options = {\n          delay: PUSH_INTERVAL,\n          transactionCallBack: transaction => {\n            self.options.appState.set('lastAuthResponse', transaction);\n          },\n        };\n\n        setTransaction(trans);\n        // In Okta verify case we initiate poll.\n        if ((trans.status === 'MFA_CHALLENGE' && trans.poll) || (trans.status === 'FACTOR_CHALLENGE' && trans.poll)) {\n          const deferred = Q.defer();\n          const initiatePollTimout = Util.callAfterTimeout(deferred.resolve, PUSH_INTERVAL);\n          self.listenToOnce(self.options.appState, 'factorSwitched', () => {\n            clearTimeout(initiatePollTimout);\n            deferred.reject(new AuthStopPollInitiationError());\n          });\n          return deferred.promise.then(function() {\n            // Stop listening if factor was not switched before poll.\n            self.stopListening(self.options.appState, 'factorSwitched');\n            if (self.pushFactorHasAutoPush()) {\n              options.autoPush = function() {\n                return self.get('autoPush');\n              };\n              options.rememberDevice = function() {\n                return self.get('rememberDevice');\n              };\n            }\n            return trans.poll(options).then(function(trans) {\n              self.options.appState.set('lastAuthResponse', trans.data);\n              setTransaction(trans);\n            });\n          });\n        }\n      });\n    });\n  },\n\n  _findFactor: function(transaction) {\n    let factor;\n\n    if (transaction.factorTypes) {\n      factor = _.findWhere(transaction.factorTypes, {\n        factorType: this.get('factorType'),\n      });\n    }\n    if (!factor) {\n      factor = _.findWhere(transaction.factors, {\n        id: this.get('id'),\n      });\n    }\n    return factor;\n  },\n\n  pushFactorHasAutoPush: function() {\n    return this.settings.get('features.autoPush') && this.get('factorType') === 'push';\n  },\n\n  setCustomHotpVendorName: function(attributes) {\n    // If factor is token:hotp and not enrolled, we assume the first profile is the default.\n    // If factor is enrolled, we only support one profile to be enrolled, so find that one\n    // and display as enrolled profile. We do this by populating profile name in vendorName.\n    if (attributes.factorType === 'token:hotp' && attributes.profiles) {\n      if (attributes.status === 'NOT_SETUP') {\n        attributes.vendorName = attributes.profiles[0].name;\n      } else if (attributes.status === 'ACTIVE') {\n        const enrolledProfiles = attributes.profiles.filter(profile => {\n          return profile._embedded.enrolledFactors.length > 0;\n        });\n        attributes.vendorName = enrolledProfiles[0].name;\n      }\n    }\n    return attributes;\n  },\n});\nconst FactorFactors = Collection.extend({\n  model: FactorFactor,\n  comparator: 'sortOrder',\n\n  // One override necessary here - When Okta Verify OTP and Push are in the list,\n  // they are presented in the view as one factor - in the beacon menu,\n  // there's only one option (Okta Verify), and we show a form with Push\n  // with an inline totp option. What we need to do is to add totp\n  // as a \"backupFactor\" for push\n  parse: function(factors) {\n    // Keep a track of the last used factor, since\n    // we need it to determine the default factor.\n    this.lastUsedFactor = factors[0];\n\n    const oktaPushFactor = _.findWhere(factors, { provider: 'OKTA', factorType: 'push' });\n\n    let totpFactor;\n\n    if (_.where(factors, { factorType: 'push' }).length > 1) {\n      totpFactor = _.findWhere(factors, { factorType: 'token:software:totp' });\n    } else {\n      totpFactor = _.findWhere(factors, { provider: 'OKTA', factorType: 'token:software:totp' });\n    }\n    if (!oktaPushFactor || !totpFactor) {\n      return factors;\n    }\n\n    const isTotpFirst = totpFactor === factors[0];\n\n    const parsedFactors = _.reduce(\n      factors,\n      function(memo, factor) {\n        const isOkta = factor.provider === 'OKTA';\n        const isOktaTotp = isOkta && factor.factorType === 'token:software:totp';\n        const isOktaPush = isOkta && factor.factorType === 'push';\n        const notEnrolled = factor.status !== 'ACTIVE';\n        const hideOktaTotp = isOktaTotp && (notEnrolled || oktaPushFactor.status === 'ACTIVE');\n        const hideOktaPush = isOktaPush && notEnrolled && totpFactor.status === 'ACTIVE';\n\n        if (hideOktaTotp || hideOktaPush) {\n          return memo;\n        }\n\n        if (isOktaPush) {\n          factor.backupFactor = new FactorFactor(totpFactor, { parse: true });\n        }\n        memo.push(factor);\n        return memo;\n      },\n      []\n    );\n\n    // Use push factor instead of TOTP, if TOTP is first in the list\n    // (since it is stored as backupFactor for push).\n    if (isTotpFirst) {\n      this.lastUsedFactor = oktaPushFactor;\n    }\n\n    return parsedFactors;\n  },\n\n  // Will need to update this to use HAL link to get last used factor:\n  // https://oktainc.atlassian.net/browse/OKTA-58380\n  // However, current code returns last used factor as first factor in list.\n  // Also, will need to add priority - i.e. if they do not have a last used\n  // factor, should try Okta Verify, then Okta SMS, etc.\n  getDefaultFactor: function() {\n    const factor = _.pick(this.lastUsedFactor, 'factorType', 'provider');\n\n    return this.findWhere(factor);\n  },\n\n  getFirstUnenrolledRequiredFactor: function() {\n    return this.findWhere({ required: true, enrolled: false });\n  },\n\n  _getFactorsOfType: function(factorType) {\n    return this.where({ factorType: factorType });\n  },\n\n  getFactorIndex: function(factorType, factorId) {\n    return this._getFactorsOfType(factorType).findIndex(function(factor) {\n      return factor.get('id') === factorId;\n    });\n  },\n\n  hasMultipleFactorsOfSameType: function(factorType) {\n    return this._getFactorsOfType(factorType).length > 1;\n  },\n\n  getFactorByTypeAndIndex: function(factorType, factorIndex) {\n    return this._getFactorsOfType(factorType)[factorIndex];\n  },\n});\nexport default {\n  Model: FactorFactor,\n  Collection: FactorFactors,\n};\n"],"names":["PUSH_INTERVAL","FactorFactor","BaseLoginModel","extend","extraProperties","flat","props","id","factorType","type","values","provider","enrollment","status","profile","vendorName","policy","profiles","local","answer","password","backupFactor","showAnswer","rememberDevice","autoPush","derived","isOktaFactor","deps","fn","factorName","factorUtil","getFactorName","factorLabel","_","contains","getFactorLabel","apply","factorDescription","getFactorDescription","sortOrder","getFactorSortOrder","iconClassName","getFactorIconClassName","securityQuestion","getSecurityQuestionLabel","phoneNumber","email","deviceName","name","enrolled","cardinality","length","_embedded","enrolledFactors","adoption","findWhere","features","minimum","min","maximum","max","additionalEnrollment","required","canUseResend","isAnswerRequired","isFactorTypeVerification","undefined","parse","attributes","settings","appState","getRememberDeviceValue","setCustomHotpVendorName","omit","validate","get","loc","needsPasscode","options","resend","trigger","manageTransaction","transaction","firstLink","data","_links","save","self","setTransaction","passCode","pushFactorHasAutoPush","promise","factor","_findFactor","verify","then","trans","delay","transactionCallBack","set","poll","deferred","Q","defer","initiatePollTimout","Util","callAfterTimeout","resolve","listenToOnce","clearTimeout","reject","AuthStopPollInitiationError","stopListening","factorTypes","factors","enrolledProfiles","filter","FactorFactors","Collection","model","comparator","lastUsedFactor","oktaPushFactor","totpFactor","where","isTotpFirst","parsedFactors","reduce","memo","isOkta","isOktaTotp","isOktaPush","notEnrolled","hideOktaTotp","hideOktaPush","push","getDefaultFactor","pick","getFirstUnenrolledRequiredFactor","_getFactorsOfType","getFactorIndex","factorId","findIndex","hasMultipleFactorsOfSameType","getFactorByTypeAndIndex","factorIndex","Model"],"mappings":"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"}
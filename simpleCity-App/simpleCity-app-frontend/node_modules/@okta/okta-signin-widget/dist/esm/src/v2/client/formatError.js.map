{"version":3,"file":"formatError.js","sources":["../../../../../src/v2/client/formatError.ts"],"sourcesContent":["/*!\n * Copyright (c) 2021-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport {\n  IdxContext,\n  IdxMessages,\n  IdxResponse,\n  RawIdxResponse\n} from '@okta/okta-auth-js';\nimport { loc } from '@okta/courage';\n\nexport interface LegacyIdxError {\n  error: string;\n  details: IdxResponse\n}\n\nexport interface StandardApiError {\n  error: string;\n  error_description: string;\n}\n\nexport function isInvalidRecoveryTokenError(error): error is StandardApiError {\n  // special case: error from interact when passing an (invalid) recovery token\n  return (error?.error === 'invalid_request' && error.error_description === 'The recovery token is invalid');\n}\n\nexport function isInvalidActivationTokenError(error): error is StandardApiError {\n  // special case: error from interact when passing an (invalid) activation token\n  return (error?.error === 'invalid_request' && error.error_description === 'The activation token is invalid');\n}\n\nexport function formatInvalidRecoveryTokenError(error: StandardApiError) {\n  // This error comes from `oauth2/interact` so is not an IDX error.\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: error.error_description,\n        i18n: {\n          key: 'oie.invalid.recovery.token'\n        },\n        class: 'ERROR'\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return idxError;\n}\n\nexport function formatInvalidActivationTokenError(error: StandardApiError) {\n  // This error comes from `oauth2/interact` so is not an IDX error.\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: error.error_description,\n        i18n: {\n          key: 'idx.missing.activation.token'\n        },\n        class: 'ERROR'\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return idxError;\n}\n\nexport function isOIENotEnabledError(error): error is StandardApiError {\n  // special case: error from interact when the Org does not have OIE enabled\n  // The response is not in IDX format. See playground/mocks/data/oauth2/error-feature-not-enabled.json\n  return (error?.error === 'access_denied' && error.error_description);\n}\n\nexport function formatOIENotEnabledError(error: StandardApiError) {\n  // This error comes from `oauth2/interact` so the error is in OAuth format\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: error.error_description,\n        i18n: {\n          key: 'oie.feature.disabled'\n        },\n        class: 'ERROR'\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return error;\n}\n\nexport function isOIEConfigurationError(error): error is StandardApiError {\n  return (error?.error && error.error_description);\n}\n\nexport function formatOIEConfigurationError(error) {\n  // This error comes from `oauth2/interact` so the error is in OAuth format\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: loc('oie.configuration.error', 'login'),\n        class: 'ERROR',\n        i18n: undefined\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return error;\n}\n\nexport function formatIDXError(error: LegacyIdxError | StandardApiError | Error): LegacyIdxError {\n  // Make the error object resemble an IDX response\n  const idxError = error as LegacyIdxError;\n  idxError.details = idxError.details || {} as IdxResponse;\n  const { details } = idxError;\n  details.rawIdxState = details.rawIdxState || {} as RawIdxResponse;\n  details.context = details.context || {} as IdxContext;\n  details.neededToProceed = details.neededToProceed || [];\n\n  // Populate generic error message if there isn't any.\n  if (!details.rawIdxState.messages) {\n    const idxMessage: IdxMessages = {\n      type: 'array',\n      value: [\n        {\n          message: loc('oform.error.unexpected', 'login'),\n          class: 'ERROR',\n          i18n: undefined\n        }\n      ]\n    };\n    details.rawIdxState.messages = idxMessage;\n    details.context.messages = idxMessage;\n  }\n\n  return idxError;\n}\n\nexport function formatError(error: string | Error | LegacyIdxError | StandardApiError) {\n  // If the error is a string, wrap it in an Error object\n  if (typeof error === 'string') {\n    error = new Error(error);\n  }\n\n  // special case error handling\n\n  // invalid reccovery token\n  if (isInvalidRecoveryTokenError(error)) {\n    return formatInvalidRecoveryTokenError(error);\n  }\n\n  // invalid activation token\n  if (isInvalidActivationTokenError(error)) {\n    return formatInvalidActivationTokenError(error);\n  }\n\n  // OIE is not enabled\n  if (isOIENotEnabledError(error)) {\n    return formatOIENotEnabledError(error);\n  }\n\n  // Other errors from /interact in OAuth format\n  if (isOIEConfigurationError(error)) {\n    return formatOIEConfigurationError(error);\n  }\n\n  error = formatIDXError(error);\n  return error;\n}"],"names":["isInvalidRecoveryTokenError","error","error_description","isInvalidActivationTokenError","formatInvalidRecoveryTokenError","idxError","formatIDXError","details","messages","type","value","message","i18n","key","class","rawIdxState","context","formatInvalidActivationTokenError","isOIENotEnabledError","formatOIENotEnabledError","isOIEConfigurationError","formatOIEConfigurationError","loc","undefined","neededToProceed","idxMessage","formatError","Error"],"mappings":"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"}
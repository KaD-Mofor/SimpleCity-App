{"version":3,"file":"BaseOktaVerifyChallengeView.js","sources":["../../../../../../src/v2/view-builder/internals/BaseOktaVerifyChallengeView.js"],"sourcesContent":["import { $, View } from '@okta/courage';\nimport { BaseFormWithPolling } from '../internals';\nimport Logger from 'util/Logger';\nimport {\n  AUTHENTICATOR_CANCEL_ACTION,\n  AUTHENTICATION_CANCEL_REASONS,\n  CHALLENGE_TIMEOUT,\n} from '../utils/Constants';\nimport BrowserFeatures from 'util/BrowserFeatures';\nimport { doChallenge, cancelPollingWithParams } from '../utils/ChallengeViewUtil';\n\nconst request = (opts) => {\n  const ajaxOptions = Object.assign({\n    method: 'GET',\n    contentType: 'application/json',\n  }, opts);\n  return $.ajax(ajaxOptions);\n};\n\nconst Body = BaseFormWithPolling.extend({\n  noButtonBar: true,\n\n  className: 'ion-form device-challenge-poll',\n\n  events: {\n    'click #launch-ov': function(e) {\n      e.preventDefault();\n      this.doCustomURI();\n    }\n  },\n\n  pollingCancelAction: AUTHENTICATOR_CANCEL_ACTION,\n\n  initialize() {\n    BaseFormWithPolling.prototype.initialize.apply(this, arguments);\n    this.listenTo(this.model, 'error', this.onPollingFail);\n    this.doChallenge();\n    this.startPolling();\n  },\n\n  doChallenge() {\n    doChallenge(this);\n  },\n\n  onPollingFail() {\n    this.$('.spinner').hide();\n    this.stopPolling();\n  },\n\n  remove() {\n    BaseFormWithPolling.prototype.remove.apply(this, arguments);\n    this.stopProbing();\n    this.stopPolling();\n  },\n\n  getDeviceChallengePayload() {\n    throw new Error('getDeviceChallengePayload needs to be implemented');\n  },\n\n  doLoopback(deviceChallenge) {\n    let authenticatorDomainUrl = deviceChallenge.domain !== undefined ? deviceChallenge.domain : '';\n    let ports = deviceChallenge.ports !== undefined ? deviceChallenge.ports : [];\n    let challengeRequest = deviceChallenge.challengeRequest !== undefined ? deviceChallenge.challengeRequest : '';\n    let probeTimeoutMillis = deviceChallenge.probeTimeoutMillis !== undefined ?\n      deviceChallenge.probeTimeoutMillis : 100;\n    let currentPort;\n    let foundPort = false;\n    let ovFailed = false;\n    let countFailedPorts = 0;\n\n    const getAuthenticatorUrl = (path) => {\n      return `${authenticatorDomainUrl}:${currentPort}/${path}`;\n    };\n\n    const checkPort = () => {\n      return request({\n        url: getAuthenticatorUrl('probe'),\n        /*\n        OKTA-278573 in loopback server, SSL handshake sometimes takes more than 100ms and thus needs additional\n        timeout however, increasing timeout is a temporary solution since user will need to wait much longer in\n        worst case.\n        TODO: Android timeout is temporarily set to 3000ms and needs optimization post-Beta.\n        OKTA-365427 introduces probeTimeoutMillis; but we should also consider probeTimeoutMillisHTTPS for\n        customizing timeouts in the more costly Android and other (keyless) HTTPS scenarios.\n        */\n        timeout: BrowserFeatures.isAndroid() ? 3000 : probeTimeoutMillis\n      });\n    };\n\n    const onPortFound = () => {\n      return request({\n        url: getAuthenticatorUrl('challenge'),\n        method: 'POST',\n        data: JSON.stringify({ challengeRequest }),\n        timeout: CHALLENGE_TIMEOUT // authenticator should respond within 5 min (300000ms) for challenge request\n      });\n    };\n\n    const onFailure = () => {\n      Logger.error(`Something unexpected happened while we were checking port ${currentPort}.`);\n    };\n\n    const doProbing = () => {\n      return checkPort()\n        .done(() => {\n          return onPortFound()\n            .done(() => {\n              foundPort = true;\n              if (deviceChallenge.enhancedPollingEnabled !== false) {\n                // this way we can gurantee that\n                // 1. the polling is triggered right away (1ms interval)\n                // 2. Only one polling queue\n                // 3. follwoing polling will continue with refresh interval from previous polling response\n                // NOTE: technically, there could still be concurrency issue where when we called stopPolling,\n                // there is already a polling triggered and hasn't completed yet\n                // but the possibility would be much smaller than previous concurrency issue\n                // this is a best effort change\n                this.stopPolling();\n                this.startPolling(1);\n                return;\n              }\n              // once the OV challenge succeeds,\n              // triggers another polling right away without waiting for the next ongoing polling to be triggered\n              // to make the authentication flow goes faster \n              return this.trigger('save', this.model);\n            })\n            .fail((xhr) => {\n              countFailedPorts++;\n              // Windows and MacOS return status code 503 when \n              // there are multiple profiles on the device and\n              // the wrong OS profile responds to the challenge request\n              if (xhr.status !== 503) {\n                // when challenge responds with other errors,\n                // - stop the remaining probing\n                ovFailed = true;\n                // - cancel polling right away\n                cancelPollingWithParams(\n                  this.options.appState,\n                  this.pollingCancelAction,\n                  AUTHENTICATION_CANCEL_REASONS.OV_ERROR,\n                  xhr.status\n                );\n              } else if (countFailedPorts === ports.length) {\n                // when challenge is responded by the wrong OS profile and\n                // all the ports are exhausted,\n                // cancel the polling like the probing has failed\n                cancelPollingWithParams(\n                  this.options.appState,\n                  this.pollingCancelAction,\n                  AUTHENTICATION_CANCEL_REASONS.LOOPBACK_FAILURE,\n                  null\n                );\n              }\n            });\n        })\n        .fail(onFailure);\n    };\n\n    let probeChain = Promise.resolve();\n    ports.forEach(port => {\n      probeChain = probeChain\n        .then(() => {\n          if (!(foundPort || ovFailed)) {\n            currentPort = port;\n            return doProbing();\n          }\n        })\n        .catch(() => {\n          countFailedPorts++;\n          Logger.error(`Authenticator is not listening on port ${currentPort}.`);\n          if (countFailedPorts === ports.length) {\n            Logger.error('No available ports. Loopback server failed and polling is cancelled.');\n            // When no port is found, cancel the polling as well\n            // This is to avoid concurrency issue where /poll/cancel takes long time to complete\n            // and SIW will receive 400 error if the polling continues\n            this.stopPolling();\n            cancelPollingWithParams(\n              this.options.appState,\n              this.pollingCancelAction,\n              AUTHENTICATION_CANCEL_REASONS.LOOPBACK_FAILURE,\n              null\n            );\n          }\n        });\n    });\n  },\n\n  doCustomURI() {\n    this.ulDom && this.ulDom.remove();\n    const IframeView = createInvisibleIFrame('custom-uri-container', this.customURI);\n    this.ulDom = this.add(IframeView).last();\n  },\n\n  doChromeDTC(deviceChallenge) {\n    this.ulDom && this.ulDom.remove();\n    const IframeView = createInvisibleIFrame('chrome-dtc-container', deviceChallenge.href);\n    this.ulDom = this.add(IframeView).last();\n  },\n\n  stopProbing() {\n    this.checkPortXhr && this.checkPortXhr.abort();\n    this.probingXhr && this.probingXhr.abort();\n  },\n});\n\nfunction createInvisibleIFrame(iFrameId, iFrameSrc) {\n  const iFrameView = View.extend({\n    tagName: 'iframe',\n    id: iFrameId,\n    attributes: {\n      src: iFrameSrc,\n    },\n    initialize() {\n      this.el.style.display = 'none';\n    }\n  });\n  return iFrameView;\n}\n\nexport default Body;\n"],"names":["request","opts","ajaxOptions","Object","assign","method","contentType","$","ajax","Body","BaseFormWithPolling","extend","noButtonBar","className","events","e","preventDefault","doCustomURI","pollingCancelAction","AUTHENTICATOR_CANCEL_ACTION","initialize","prototype","apply","arguments","listenTo","model","onPollingFail","doChallenge","startPolling","hide","stopPolling","remove","stopProbing","getDeviceChallengePayload","Error","doLoopback","deviceChallenge","authenticatorDomainUrl","domain","undefined","ports","challengeRequest","probeTimeoutMillis","currentPort","foundPort","ovFailed","countFailedPorts","getAuthenticatorUrl","path","checkPort","url","timeout","BrowserFeatures","isAndroid","onPortFound","data","JSON","stringify","CHALLENGE_TIMEOUT","onFailure","Logger","error","doProbing","done","enhancedPollingEnabled","trigger","fail","xhr","status","cancelPollingWithParams","options","appState","AUTHENTICATION_CANCEL_REASONS","OV_ERROR","length","LOOPBACK_FAILURE","probeChain","Promise","resolve","forEach","port","then","catch","ulDom","IframeView","createInvisibleIFrame","customURI","add","last","doChromeDTC","href","checkPortXhr","abort","probingXhr","iFrameId","iFrameSrc","iFrameView","View","tagName","id","attributes","src","el","style","display"],"mappings":"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"}
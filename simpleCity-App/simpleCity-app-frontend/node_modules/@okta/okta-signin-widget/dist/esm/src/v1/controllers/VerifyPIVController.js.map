{"version":3,"file":"VerifyPIVController.js","sources":["../../../../../src/v1/controllers/VerifyPIVController.js"],"sourcesContent":["/*!\n * Copyright (c) 2019, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint complexity:[2, 10], max-params: [2, 11] */\nimport { _, $, loc, View, internal } from '@okta/courage';\nimport hbs from '@okta/handlebars-inline-precompile';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport FooterWithBackLink from 'v1/views/shared/FooterWithBackLink';\nlet { Util } = internal.util;\nexport default FormController.extend({\n  className: 'piv-cac-card',\n  Model: {\n    save: async function() {\n      this.trigger('request');\n      const self = this;\n      const pivConfig = this.settings.get('piv');\n      const data = {\n        fromURI: this.settings.get('relayState'),\n        isCustomDomain: pivConfig.isCustomDomain,\n        customDomain: pivConfig.customDomain,\n      };\n\n      try {\n        await this.getCert(pivConfig.certAuthUrl);\n        const res = await this.postCert(pivConfig.certAuthUrl, data);\n        Util.redirect(res.redirectUrl);\n      } catch (err) {\n        if (_.isEmpty(err.responseJSON) && !err.responseText) {\n          err.responseJSON = {\n            errorSummary: loc('piv.cac.error', 'login'),\n          };\n        }\n        self.trigger('error', self, err);\n      }\n    },\n\n    getCert: function(certAuthUrl) {\n      return $.get({\n        url: certAuthUrl,\n        xhrFields: {\n          withCredentials: true,\n        },\n        beforeSend: function() {\n          // overriding this function to prevent our jquery-wrapper from\n          // setting headers. Need to keep this a simple request in order for\n          // PIV / CAC to work in IE.\n        },\n      });\n    },\n\n    postCert: function(certAuthUrl, data) {\n      return $.post({\n        url: certAuthUrl,\n        xhrFields: {\n          withCredentials: true,\n        },\n        data: JSON.stringify(data),\n        contentType: 'text/plain',\n        beforeSend: function() {\n          // overriding this function to prevent our jquery-wrapper from\n          // setting headers. Need to keep this a simple request in order for\n          // PIV / CAC to work in IE.\n        },\n      });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: _.partial(loc, 'piv.cac.title', 'login'),\n    className: 'piv-cac-card',\n    noCancelButton: true,\n    save: _.partial(loc, 'retry', 'login'),\n    modelEvents: {\n      request: '_startEnrollment',\n      error: '_stopEnrollment',\n    },\n\n    formChildren: [\n      FormType.View({\n        View: View.extend({\n          template: hbs(\n            '<div class=\"piv-verify-text\">\\\n               <p>{{i18n code=\"piv.cac.card.insert\" bundle=\"login\"}}</p>\\\n               <div data-se=\"piv-waiting\" class=\"okta-waiting-spinner\"></div>\\\n             </div>'\n          ),\n        }),\n      }),\n    ],\n\n    _startEnrollment: function() {\n      this.$('.okta-waiting-spinner').show();\n      this.$('.o-form-button-bar').hide();\n    },\n\n    _stopEnrollment: function() {\n      this.$('.okta-waiting-spinner').hide();\n      this.$('.o-form-button-bar').show();\n    },\n\n    postRender: function() {\n      _.defer(() => {\n        this.model.save();\n      });\n    },\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  Footer: FooterWithBackLink,\n});\n"],"names":["Util","internal","util","FormController","extend","className","Model","save","trigger","self","pivConfig","settings","get","data","fromURI","isCustomDomain","customDomain","getCert","certAuthUrl","res","postCert","redirect","redirectUrl","err","_","isEmpty","responseJSON","responseText","errorSummary","loc","$","url","xhrFields","withCredentials","beforeSend","post","JSON","stringify","contentType","Form","autoSave","hasSavingState","title","partial","noCancelButton","modelEvents","request","error","formChildren","FormType","View","template","_startEnrollment","show","hide","_stopEnrollment","postRender","defer","model","back","Footer","FooterWithBackLink"],"mappings":"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"}